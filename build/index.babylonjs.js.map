{"version":3,"file":"index.babylonjs.js","sources":["../src/babylonjs/renderer/loaders/GLTFLoader.js","../src/babylonjs/renderer/loaders/B3DMLoader.js","../src/babylonjs/renderer/math/OBB.js","../src/babylonjs/renderer/math/TileBoundingVolume.js","../src/babylonjs/renderer/tiles/TilesRenderer.js"],"sourcesContent":["import { LoaderBase } from '3d-tiles-renderer/core';\nimport { Matrix, Quaternion, ImportMeshAsync } from '@babylonjs/core';\nimport '@babylonjs/loaders/glTF/2.0';\n\nconst _worldMatrix = /* @__PURE__ */ Matrix.Identity();\n\nexport class GLTFLoader extends LoaderBase {\n\n\tconstructor( scene ) {\n\n\t\tsuper();\n\t\tthis.scene = scene;\n\t\tthis.adjustmentTransform = Matrix.Identity();\n\n\t}\n\n\n\tasync parse( buffer, uri, extension ) {\n\n\t\tconst { scene, workingPath, adjustmentTransform } = this;\n\n\t\t// ensure working path ends in a slash for proper resource resolution\n\t\tlet rootUrl = workingPath;\n\t\tif ( rootUrl.length && ! /[\\\\/]$/.test( rootUrl ) ) {\n\n\t\t\trootUrl += '/';\n\n\t\t}\n\n\t\t// load the file\n\t\tconst pluginExtension = extension === 'gltf' ? '.gltf' : '.glb';\n\t\tlet metadata = null;\n\t\tconst container = await ImportMeshAsync(\n\t\t\tnew File( [ buffer ], uri ),\n\t\t\tscene,\n\t\t\t{\n\t\t\t\tpluginExtension,\n\t\t\t\trootUrl,\n\t\t\t\tpluginOptions: {\n\t\t\t\t\t'gltf': {\n\t\t\t\t\t\tonParsed: ( loaderData ) => {\n\n\t\t\t\t\t\t\t// loaderData.json contains the full glTF JSON\n\t\t\t\t\t\t\tmetadata = loaderData.json;\n\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\t// retrieve the primary scene\n\t\tconst root = container.meshes[ 0 ];\n\n\t\t// ensure rotationQuaternion is initialized so we can decompose the matrix\n\t\troot.rotationQuaternion = Quaternion.Identity();\n\n\t\t// adjust the transform the model by the necessary rotation correction\n\t\tconst worldMatrix = root.computeWorldMatrix( true );\n\t\tadjustmentTransform.multiplyToRef( worldMatrix, _worldMatrix );\n\t\t_worldMatrix.decompose( root.scaling, root.rotationQuaternion, root.position );\n\n\t\treturn {\n\t\t\tscene: root,\n\t\t\tcontainer,\n\t\t\tmetadata,\n\t\t};\n\n\t}\n\n}\n","import { Matrix } from '@babylonjs/core';\nimport { B3DMLoaderBase } from '3d-tiles-renderer/core';\nimport { GLTFLoader } from './GLTFLoader.js';\n\nexport class B3DMLoader extends B3DMLoaderBase {\n\n\tconstructor( scene ) {\n\n\t\tsuper();\n\t\tthis.scene = scene;\n\t\tthis.adjustmentTransform = Matrix.Identity();\n\n\t}\n\n\tasync parse( buffer, uri ) {\n\n\t\tconst b3dm = super.parse( buffer );\n\n\t\tconst { scene, workingPath, fetchOptions, adjustmentTransform } = this;\n\n\t\t// init gltf loader\n\t\tconst gltfLoader = new GLTFLoader( scene );\n\t\tgltfLoader.workingPath = workingPath;\n\t\tgltfLoader.fetchOptions = fetchOptions;\n\t\tif ( adjustmentTransform ) {\n\n\t\t\tgltfLoader.adjustmentTransform = adjustmentTransform;\n\n\t\t}\n\n\t\t// parse the file\n\t\tconst result = await gltfLoader.parse( b3dm.glbBytes, uri, 'glb' );\n\t\tconst gltfScene = result.scene;\n\t\treturn {\n\t\t\t...b3dm,\n\t\t\tscene: gltfScene,\n\t\t\tcontainer: result.container,\n\t\t\tmetadata: result.metadata,\n\t\t};\n\n\t}\n\n}\n","import { Vector3, Matrix, BoundingBox } from '@babylonjs/core';\n\nconst _vec = /* @__PURE__ */ new Vector3();\nexport class OBB {\n\n\tconstructor() {\n\n\t\tthis.min = new Vector3( - 1, - 1, - 1 );\n\t\tthis.max = new Vector3( 1, 1, 1 );\n\t\tthis.transform = Matrix.Identity();\n\t\tthis.inverseTransform = Matrix.Identity();\n\t\tthis.points = new Array( 8 ).fill( null ).map( () => new Vector3() );\n\n\t}\n\n\tupdate() {\n\n\t\tconst { min, max, points, transform } = this;\n\t\ttransform.invertToRef( this.inverseTransform );\n\n\t\t// update corner points\n\t\tlet index = 0;\n\t\tfor ( let x = 0; x <= 1; x ++ ) {\n\n\t\t\tfor ( let y = 0; y <= 1; y ++ ) {\n\n\t\t\t\tfor ( let z = 0; z <= 1; z ++ ) {\n\n\t\t\t\t\tpoints[ index ].set(\n\t\t\t\t\t\tx === 0 ? min.x : max.x,\n\t\t\t\t\t\ty === 0 ? min.y : max.y,\n\t\t\t\t\t\tz === 0 ? min.z : max.z,\n\t\t\t\t\t);\n\t\t\t\t\tVector3.TransformCoordinatesToRef(\n\t\t\t\t\t\tpoints[ index ],\n\t\t\t\t\t\ttransform,\n\t\t\t\t\t\tpoints[ index ],\n\t\t\t\t\t);\n\t\t\t\t\tindex ++;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\tclampPoint( point, result ) {\n\n\t\tconst { min, max, transform, inverseTransform } = this;\n\n\t\tVector3.TransformCoordinatesToRef( point, inverseTransform, result );\n\t\tresult.x = Math.max( min.x, Math.min( max.x, result.x ) );\n\t\tresult.y = Math.max( min.y, Math.min( max.y, result.y ) );\n\t\tresult.z = Math.max( min.z, Math.min( max.z, result.z ) );\n\n\t\t// transform back to world space\n\t\tVector3.TransformCoordinatesToRef( result, transform, result );\n\n\t\treturn result;\n\n\t}\n\n\tdistanceToPoint( point ) {\n\n\t\tthis.clampPoint( point, _vec );\n\t\treturn Vector3.Distance( _vec, point );\n\n\t}\n\n\tintersectsFrustum( frustumPlanes ) {\n\n\t\t// TODO: implement a more robust OBB / Frustum check. This one includes false positives.\n\t\treturn BoundingBox.IsInFrustum( this.points, frustumPlanes );\n\n\t}\n\n}\n","import { Vector3, Matrix, BoundingSphere } from '@babylonjs/core';\nimport { OBB } from './OBB.js';\n\nconst _vecX = /* @__PURE__ */ new Vector3();\nconst _vecY = /* @__PURE__ */ new Vector3();\nconst _vecZ = /* @__PURE__ */ new Vector3();\nconst _scale = /* @__PURE__ */ new Vector3();\nconst _empty = /* @__PURE__ */ new Vector3();\n\nexport class TileBoundingVolume {\n\n\tconstructor() {\n\n\t\tthis.sphere = null;\n\t\tthis.obb = null;\n\n\t}\n\n\tsetSphereData( x, y, z, radius, transform ) {\n\n\t\tconst sphere = new BoundingSphere( _empty, _empty );\n\n\t\tconst center = sphere.centerWorld.set( x, y, z );\n\t\tVector3.TransformCoordinatesToRef( center, transform, center );\n\n\t\ttransform.decompose( _scale, null, null );\n\t\tsphere.radiusWorld = radius * Math.max( Math.abs( _scale.x ), Math.abs( _scale.y ), Math.abs( _scale.z ) );\n\n\t\tthis.sphere = sphere;\n\n\t}\n\n\tsetObbData( data, transform ) {\n\n\t\tconst obb = new OBB();\n\n\t\t// get the extents of the bounds in each axis\n\t\t_vecX.set( data[ 3 ], data[ 4 ], data[ 5 ] );\n\t\t_vecY.set( data[ 6 ], data[ 7 ], data[ 8 ] );\n\t\t_vecZ.set( data[ 9 ], data[ 10 ], data[ 11 ] );\n\n\t\tconst scaleX = _vecX.length();\n\t\tconst scaleY = _vecY.length();\n\t\tconst scaleZ = _vecZ.length();\n\n\t\t_vecX.normalize();\n\t\t_vecY.normalize();\n\t\t_vecZ.normalize();\n\n\t\t// handle the case where the box has a dimension of 0 in one axis\n\t\tif ( scaleX === 0 ) {\n\n\t\t\tVector3.CrossToRef( _vecY, _vecZ, _vecX );\n\n\t\t}\n\n\t\tif ( scaleY === 0 ) {\n\n\t\t\tVector3.CrossToRef( _vecX, _vecZ, _vecY );\n\n\t\t}\n\n\t\tif ( scaleZ === 0 ) {\n\n\t\t\tVector3.CrossToRef( _vecX, _vecY, _vecZ );\n\n\t\t}\n\n\t\t// create the oriented frame that the box exists in\n\t\t// Note that Babylon seems to take data in column major ordering rather than row-major like three.js\n\t\t// (despite the docs seeming to imply that it's row major) so we transpose afterward\n\t\tobb.transform = Matrix\n\t\t\t.FromValues(\n\t\t\t\t_vecX.x, _vecY.x, _vecZ.x, data[ 0 ],\n\t\t\t\t_vecX.y, _vecY.y, _vecZ.y, data[ 1 ],\n\t\t\t\t_vecX.z, _vecY.z, _vecZ.z, data[ 2 ],\n\t\t\t\t0, 0, 0, 1,\n\t\t\t)\n\t\t\t.transpose()\n\t\t\t.multiply( transform );\n\n\t\t// scale the box by the extents\n\t\tobb.min.set( - scaleX, - scaleY, - scaleZ );\n\t\tobb.max.set( scaleX, scaleY, scaleZ );\n\t\tobb.update();\n\t\tthis.obb = obb;\n\n\t}\n\n\tdistanceToPoint( point ) {\n\n\t\tconst { sphere, obb } = this;\n\n\t\tlet sphereDistance = - Infinity;\n\t\tlet obbDistance = - Infinity;\n\n\t\tif ( sphere ) {\n\n\t\t\tsphereDistance = Vector3.Distance( point, sphere.centerWorld ) - sphere.radiusWorld;\n\t\t\tsphereDistance = Math.max( sphereDistance, 0 );\n\n\t\t}\n\n\t\tif ( obb ) {\n\n\t\t\tobbDistance = obb.distanceToPoint( point );\n\n\t\t}\n\n\t\t// return the further distance of the two volumes\n\t\treturn sphereDistance > obbDistance ? sphereDistance : obbDistance;\n\n\t}\n\n\tintersectsFrustum( frustumPlanes ) {\n\n\t\tconst { sphere, obb } = this;\n\n\t\tif ( sphere && ! sphere.isInFrustum( frustumPlanes ) ) {\n\n\t\t\treturn false;\n\n\t\t}\n\n\t\tif ( obb && ! obb.intersectsFrustum( frustumPlanes ) ) {\n\n\t\t\treturn false;\n\n\t\t}\n\n\t\t// if we don't have a sphere or obb then just say we did intersect\n\t\treturn Boolean( sphere || obb );\n\n\t}\n\n}\n","import { TilesRendererBase, LoaderUtils } from '3d-tiles-renderer/core';\nimport { TransformNode, Matrix, Vector3, Frustum, Observable, Plane } from '@babylonjs/core';\nimport { B3DMLoader } from '../loaders/B3DMLoader.js';\nimport { GLTFLoader } from '../loaders/GLTFLoader.js';\nimport { TileBoundingVolume } from '../math/TileBoundingVolume.js';\n\n// Scratch variables to avoid allocations\nconst _worldToTiles = /* @__PURE__ */ Matrix.Identity();\nconst _cameraPositionInTiles = /* @__PURE__ */ new Vector3();\nconst _frustumPlanes = /* @__PURE__ */ new Array( 6 ).fill( null ).map( () => new Plane( 0, 0, 0, 0 ) );\n\n// TODO: implementation does not support left handed coordinate system\nexport class TilesRenderer extends TilesRendererBase {\n\n\tconstructor( url, scene ) {\n\n\t\tsuper( url );\n\n\t\tthis.scene = scene;\n\t\tthis.group = new TransformNode( 'tiles-root', scene );\n\t\tthis._upRotationMatrix = Matrix.Identity();\n\n\t\t// Babylon.js Observables for events\n\t\tthis._observables = new Map();\n\n\t}\n\n\taddEventListener( type, listener ) {\n\n\t\tif ( ! this._observables.has( type ) ) {\n\n\t\t\tthis._observables.set( type, new Observable() );\n\n\t\t}\n\n\t\tthis._observables.get( type ).add( listener );\n\n\t}\n\n\tremoveEventListener( type, listener ) {\n\n\t\tif ( ! this._observables.has( type ) ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst observable = this._observables.get( type );\n\t\tobservable.removeCallback( listener );\n\n\t}\n\n\tdispatchEvent( event ) {\n\n\t\tif ( ! this._observables.has( event.type ) ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst observable = this._observables.get( event.type );\n\t\tobservable.notifyObservers( event );\n\n\t}\n\n\tloadRootTileset( ...args ) {\n\n\t\treturn super.loadRootTileset( ...args )\n\t\t\t.then( root => {\n\n\t\t\t\t// cache the gltf tileset rotation matrix\n\t\t\t\tconst { asset } = root;\n\t\t\t\tconst upAxis = asset && asset.gltfUpAxis || 'y';\n\t\t\t\tswitch ( upAxis.toLowerCase() ) {\n\n\t\t\t\t\tcase 'x':\n\t\t\t\t\t\tMatrix.RotationYToRef( - Math.PI / 2, this._upRotationMatrix );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 'y':\n\t\t\t\t\t\tMatrix.RotationXToRef( Math.PI / 2, this._upRotationMatrix );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t\treturn root;\n\n\t\t\t} );\n\n\t}\n\n\tpreprocessNode( tile, tilesetDir, parentTile = null ) {\n\n\t\tsuper.preprocessNode( tile, tilesetDir, parentTile );\n\n\t\t// Build the transform matrix for this tile\n\t\tconst transform = Matrix.Identity();\n\t\tif ( tile.transform ) {\n\n\t\t\t// 3d tiles uses column major\n\t\t\tMatrix.FromValuesToRef( ...tile.transform, transform );\n\n\t\t}\n\n\t\tif ( parentTile ) {\n\n\t\t\t// parentTransform * transform\n\t\t\ttransform.multiplyToRef( parentTile.engineData.transform, transform );\n\n\t\t}\n\n\t\tconst transformInverse = Matrix.Identity();\n\t\ttransform.invertToRef( transformInverse );\n\t\tconst boundingVolume = new TileBoundingVolume();\n\t\tif ( 'sphere' in tile.boundingVolume ) {\n\n\t\t\tboundingVolume.setSphereData( ...tile.boundingVolume.sphere, transform );\n\n\t\t}\n\n\t\tif ( 'box' in tile.boundingVolume ) {\n\n\t\t\tboundingVolume.setObbData( tile.boundingVolume.box, transform );\n\n\t\t}\n\n\t\ttile.engineData.transform = transform;\n\t\ttile.engineData.transformInverse = transformInverse;\n\t\ttile.engineData.boundingVolume = boundingVolume;\n\t\ttile.engineData.active = false;\n\t\ttile.engineData.scene = null;\n\t\ttile.engineData.container = null;\n\n\t}\n\n\tasync parseTile( buffer, tile, extension, uri, abortSignal ) {\n\n\t\tconst engineData = tile.engineData;\n\t\tconst rootScene = this.scene;\n\t\tconst workingPath = LoaderUtils.getWorkingPath( uri );\n\t\tconst fetchOptions = this.fetchOptions;\n\n\t\tconst tileTransform = engineData.transform;\n\t\tconst upRotationMatrix = this._upRotationMatrix;\n\n\t\tlet result = null;\n\t\tconst fileType = ( LoaderUtils.readMagicBytes( buffer ) || extension ).toLowerCase();\n\n\t\tswitch ( fileType ) {\n\n\t\t\tcase 'b3dm': {\n\n\t\t\t\tconst loader = new B3DMLoader( rootScene );\n\t\t\t\tloader.workingPath = workingPath;\n\t\t\t\tloader.fetchOptions = fetchOptions;\n\t\t\t\tloader.adjustmentTransform.copyFrom( upRotationMatrix );\n\n\t\t\t\tresult = await loader.parse( buffer, uri );\n\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tcase 'gltf':\n\t\t\tcase 'glb': {\n\n\t\t\t\tconst loader = new GLTFLoader( rootScene );\n\t\t\t\tloader.workingPath = workingPath;\n\t\t\t\tloader.fetchOptions = fetchOptions;\n\t\t\t\tloader.adjustmentTransform.copyFrom( upRotationMatrix );\n\n\t\t\t\tresult = await loader.parse( buffer, uri, extension );\n\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tdefault:\n\t\t\t\tthrow new Error( `BabylonTilesRenderer: Content type \"${ fileType }\" not supported.` );\n\n\t\t}\n\n\t\tconst scene = result.scene;\n\t\tscene.setEnabled( false );\n\n\t\t// apply the tile's cached transform to the loaded scene\n\t\tscene\n\t\t\t.computeWorldMatrix( true )\n\t\t\t.multiply( tileTransform )\n\t\t\t.decompose( scene.scaling, scene.rotationQuaternion, scene.position );\n\n\t\t// exit early if a new request has already started\n\t\tif ( abortSignal.aborted ) {\n\n\t\t\tresult.container.dispose();\n\t\t\treturn;\n\n\t\t}\n\n\t\tengineData.scene = scene;\n\t\tengineData.container = result.container;\n\t\tengineData.metadata = result.metadata || null;\n\n\t}\n\n\tdisposeTile( tile ) {\n\n\t\tsuper.disposeTile( tile );\n\n\t\tconst engineData = tile.engineData;\n\t\tif ( engineData.container ) {\n\n\t\t\tengineData.container.dispose();\n\t\t\tengineData.container = null;\n\t\t\tengineData.scene = null;\n\t\t\tengineData.metadata = null;\n\n\t\t}\n\n\t}\n\n\tsetTileVisible( tile, visible ) {\n\n\t\tconst engineData = tile.engineData;\n\t\tconst scene = engineData.scene;\n\n\t\tif ( ! scene ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tif ( visible ) {\n\n\t\t\tscene.parent = this.group;\n\t\t\tscene.setEnabled( true );\n\n\t\t} else {\n\n\t\t\tscene.parent = null;\n\t\t\tscene.setEnabled( false );\n\n\t\t}\n\n\t\tsuper.setTileVisible( tile, visible );\n\n\t}\n\n\tcalculateBytesUsed( tile ) {\n\n\t\t// TODO: return the estimated amount of bytes used by the renderer\n\t\treturn 1;\n\n\t}\n\n\tcalculateTileViewError( tile, target ) {\n\n\t\t// TODO: cache frustum planes etc to improve performance\n\t\tconst { scene } = this;\n\n\t\tconst engineData = tile.engineData;\n\t\tconst boundingVolume = engineData.boundingVolume;\n\t\tconst camera = scene.activeCamera;\n\n\t\t// get the render resolution\n\t\tconst engine = scene.getEngine();\n\t\tconst hardwareScaling = engine.getHardwareScalingLevel();\n\t\tconst width = engine.getRenderWidth() * hardwareScaling;\n\t\tconst height = engine.getRenderHeight() * hardwareScaling;\n\n\t\t// get projection camera info\n\t\tconst projection = camera.getProjectionMatrix();\n\t\tconst projectionElements = projection.m;\n\t\tconst isOrthographic = projectionElements[ 15 ] === 1;\n\n\t\t// calculate SSE denominator or pixel size\n\t\tlet sseDenominator;\n\t\tlet pixelSize;\n\t\tif ( isOrthographic ) {\n\n\t\t\tconst w = 2 / projectionElements[ 0 ];\n\t\t\tconst h = 2 / projectionElements[ 5 ];\n\t\t\tpixelSize = Math.max( h / height, w / width );\n\n\t\t} else {\n\n\t\t\tsseDenominator = ( 2 / projectionElements[ 5 ] ) / height;\n\n\t\t}\n\n\t\t// calculate the frustum planes and distances in local tile coordinates\n\t\tthis.group.getWorldMatrix().invertToRef( _worldToTiles );\n\t\tVector3.TransformCoordinatesToRef( camera.globalPosition, _worldToTiles, _cameraPositionInTiles );\n\n\t\t// get frustums in local space: note tht it seems there's no way to transform to ref in Babylon\n\t\tFrustum.GetPlanesToRef( camera.getTransformationMatrix( true ), _frustumPlanes );\n\t\tconst frustumPlanes = _frustumPlanes.map( plane => {\n\n\t\t\treturn plane.transform( _worldToTiles );\n\n\t\t} );\n\n\t\tconst distance = boundingVolume.distanceToPoint( _cameraPositionInTiles );\n\n\t\tlet error;\n\t\tif ( isOrthographic ) {\n\n\t\t\terror = tile.geometricError / pixelSize;\n\n\t\t} else {\n\n\t\t\t// Avoid dividing by 0\n\t\t\terror = distance === 0 ? Infinity : tile.geometricError / ( distance * sseDenominator );\n\n\t\t}\n\n\t\t// Check frustum intersection\n\t\tconst inView = boundingVolume.intersectsFrustum( frustumPlanes );\n\n\t\ttarget.inView = inView;\n\t\ttarget.error = error;\n\t\ttarget.distanceFromCamera = distance;\n\n\t}\n\n\tdispose() {\n\n\t\tsuper.dispose();\n\t\tthis.group.dispose();\n\n\t}\n\n}\n"],"names":["_worldMatrix","Matrix","GLTFLoader","LoaderBase","scene","buffer","uri","extension","workingPath","adjustmentTransform","rootUrl","pluginExtension","metadata","container","ImportMeshAsync","loaderData","root","Quaternion","worldMatrix","B3DMLoader","B3DMLoaderBase","b3dm","fetchOptions","gltfLoader","result","gltfScene","_vec","Vector3","OBB","min","max","points","transform","index","x","y","z","point","inverseTransform","frustumPlanes","BoundingBox","_vecX","_vecY","_vecZ","_scale","_empty","TileBoundingVolume","radius","sphere","BoundingSphere","center","data","obb","scaleX","scaleY","scaleZ","sphereDistance","obbDistance","_worldToTiles","_cameraPositionInTiles","_frustumPlanes","Plane","TilesRenderer","TilesRendererBase","url","TransformNode","type","listener","Observable","event","args","asset","tile","tilesetDir","parentTile","transformInverse","boundingVolume","abortSignal","engineData","rootScene","LoaderUtils.getWorkingPath","tileTransform","upRotationMatrix","fileType","LoaderUtils.readMagicBytes","loader","visible","target","camera","engine","hardwareScaling","width","height","projectionElements","isOrthographic","sseDenominator","pixelSize","w","h","Frustum","plane","distance","error","inView"],"mappings":"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"}