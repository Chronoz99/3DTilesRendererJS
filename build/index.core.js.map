{"version":3,"file":"index.core.js","sources":["../src/core/renderer/loaders/I3DMLoaderBase.js","../src/core/renderer/loaders/PNTSLoaderBase.js","../src/core/renderer/loaders/CMPTLoaderBase.js"],"sourcesContent":["// I3DM File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Instanced3DModel/README.md\n\nimport { BatchTable } from '../utilities/BatchTable.js';\nimport { FeatureTable } from '../utilities/FeatureTable.js';\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes, arrayToString, getWorkingPath } from '../utilities/LoaderUtils.js';\n\nexport class I3DMLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 32-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'i3dm' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1 );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength );\n\n\t\t// 4 bytes\n\t\tconst featureTableJSONByteLength = dataView.getUint32( 12, true );\n\n\t\t// 4 bytes\n\t\tconst featureTableBinaryByteLength = dataView.getUint32( 16, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableJSONByteLength = dataView.getUint32( 20, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableBinaryByteLength = dataView.getUint32( 24, true );\n\n\t\t// 4 bytes\n\t\tconst gltfFormat = dataView.getUint32( 28, true );\n\n\t\t// Feature Table\n\t\tconst featureTableStart = 32;\n\t\tconst featureTableBuffer = buffer.slice(\n\t\t\tfeatureTableStart,\n\t\t\tfeatureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength,\n\t\t);\n\t\tconst featureTable = new FeatureTable(\n\t\t\tfeatureTableBuffer,\n\t\t\t0,\n\t\t\tfeatureTableJSONByteLength,\n\t\t\tfeatureTableBinaryByteLength,\n\t\t);\n\n\t\t// Batch Table\n\t\tconst batchTableStart = featureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength;\n\t\tconst batchTableBuffer = buffer.slice(\n\t\t\tbatchTableStart,\n\t\t\tbatchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength,\n\t\t);\n\t\tconst batchTable = new BatchTable(\n\t\t\tbatchTableBuffer,\n\t\t\tfeatureTable.getData( 'INSTANCES_LENGTH' ),\n\t\t\t0,\n\t\t\tbatchTableJSONByteLength,\n\t\t\tbatchTableBinaryByteLength,\n\t\t);\n\n\t\tconst glbStart = batchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength;\n\t\tconst bodyBytes = new Uint8Array( buffer, glbStart, byteLength - glbStart );\n\n\t\tlet glbBytes = null;\n\t\tlet promise = null;\n\t\tlet gltfWorkingPath = null;\n\t\tif ( gltfFormat ) {\n\n\t\t\tglbBytes = bodyBytes;\n\t\t\tpromise = Promise.resolve();\n\n\t\t} else {\n\n\t\t\tconst externalUri = this.resolveExternalURL( arrayToString( bodyBytes ) );\n\n\t\t\t//Store the gltf working path\n\t\t\tgltfWorkingPath = getWorkingPath( externalUri );\n\n\t\t\tpromise = fetch( externalUri, this.fetchOptions )\n\t\t\t\t.then( res => {\n\n\t\t\t\t\tif ( ! res.ok ) {\n\n\t\t\t\t\t\tthrow new Error( `I3DMLoaderBase : Failed to load file \"${ externalUri }\" with status ${ res.status } : ${ res.statusText }` );\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn res.arrayBuffer();\n\n\t\t\t\t} )\n\t\t\t\t.then( buffer => {\n\n\t\t\t\t\tglbBytes = new Uint8Array( buffer );\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\treturn promise.then( () => {\n\n\t\t\treturn {\n\t\t\t\tversion,\n\t\t\t\tfeatureTable,\n\t\t\t\tbatchTable,\n\t\t\t\tglbBytes,\n\t\t\t\tgltfWorkingPath\n\t\t\t};\n\n\t\t} );\n\n\t}\n\n}\n\n","// PNTS File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/PointCloud/README.md\n\nimport { BatchTable } from '../utilities/BatchTable.js';\nimport { FeatureTable } from '../utilities/FeatureTable.js';\nimport { readMagicBytes } from '../utilities/LoaderUtils.js';\nimport { LoaderBase } from './LoaderBase.js';\n\nexport class PNTSLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 28-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'pnts' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1 );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength );\n\n\t\t// 4 bytes\n\t\tconst featureTableJSONByteLength = dataView.getUint32( 12, true );\n\n\t\t// 4 bytes\n\t\tconst featureTableBinaryByteLength = dataView.getUint32( 16, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableJSONByteLength = dataView.getUint32( 20, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableBinaryByteLength = dataView.getUint32( 24, true );\n\n\t\t// Feature Table\n\t\tconst featureTableStart = 28;\n\t\tconst featureTableBuffer = buffer.slice(\n\t\t\tfeatureTableStart,\n\t\t\tfeatureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength,\n\t\t);\n\t\tconst featureTable = new FeatureTable(\n\t\t\tfeatureTableBuffer,\n\t\t\t0,\n\t\t\tfeatureTableJSONByteLength,\n\t\t\tfeatureTableBinaryByteLength,\n\t\t);\n\n\t\t// Batch Table\n\t\tconst batchTableStart = featureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength;\n\t\tconst batchTableBuffer = buffer.slice(\n\t\t\tbatchTableStart,\n\t\t\tbatchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength,\n\t\t);\n\t\tconst batchTable = new BatchTable(\n\t\t\tbatchTableBuffer,\n\t\t\tfeatureTable.getData( 'BATCH_LENGTH' ) || featureTable.getData( 'POINTS_LENGTH' ),\n\t\t\t0,\n\t\t\tbatchTableJSONByteLength,\n\t\t\tbatchTableBinaryByteLength,\n\t\t);\n\n\t\treturn Promise.resolve( {\n\n\t\t\tversion,\n\t\t\tfeatureTable,\n\t\t\tbatchTable,\n\n\t\t} );\n\n\t}\n\n}\n\n","// CMPT File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Composite/README.md\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes } from '../utilities/LoaderUtils.js';\n\nexport class CMPTLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 16-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'cmpt', 'CMPTLoader: The magic bytes equal \"cmpt\".' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1, 'CMPTLoader: The version listed in the header is \"1\".' );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength, 'CMPTLoader: The contents buffer length listed in the header matches the file.' );\n\n\t\t// 4 bytes\n\t\tconst tilesLength = dataView.getUint32( 12, true );\n\n\t\tconst tiles = [];\n\t\tlet offset = 16;\n\t\tfor ( let i = 0; i < tilesLength; i ++ ) {\n\n\t\t\tconst tileView = new DataView( buffer, offset, 12 );\n\t\t\tconst tileMagic = readMagicBytes( tileView );\n\t\t\tconst tileVersion = tileView.getUint32( 4, true );\n\t\t\tconst byteLength = tileView.getUint32( 8, true );\n\n\t\t\tconst tileBuffer = new Uint8Array( buffer, offset, byteLength );\n\t\t\ttiles.push( {\n\n\t\t\t\ttype: tileMagic,\n\t\t\t\tbuffer: tileBuffer,\n\t\t\t\tversion: tileVersion,\n\n\t\t\t} );\n\t\t\toffset += byteLength;\n\n\t\t}\n\n\t\treturn {\n\t\t\tversion,\n\t\t\ttiles,\n\t\t};\n\n\t}\n\n}\n\n"],"names":["I3DMLoaderBase","LoaderBase","buffer","dataView","magic","readMagicBytes","version","byteLength","featureTableJSONByteLength","featureTableBinaryByteLength","batchTableJSONByteLength","batchTableBinaryByteLength","gltfFormat","featureTableStart","featureTableBuffer","featureTable","FeatureTable","batchTableStart","batchTableBuffer","batchTable","BatchTable","glbStart","bodyBytes","glbBytes","promise","gltfWorkingPath","externalUri","arrayToString","getWorkingPath","res","PNTSLoaderBase","CMPTLoaderBase","tilesLength","tiles","offset","i","tileView","tileMagic","tileVersion","tileBuffer"],"mappings":"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"}