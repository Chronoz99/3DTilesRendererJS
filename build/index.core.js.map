{"version":3,"file":"index.core.js","sources":["../src/core/renderer/utilities/urlExtension.js","../src/core/renderer/tiles/traverseFunctions.js","../src/core/renderer/utilities/throttle.js","../src/core/renderer/tiles/TilesRendererBase.js","../src/core/renderer/utilities/FeatureTable.js","../src/core/renderer/utilities/BatchTableHierarchyExtension.js","../src/core/renderer/utilities/BatchTable.js","../src/core/renderer/loaders/B3DMLoaderBase.js","../src/core/renderer/loaders/I3DMLoaderBase.js","../src/core/renderer/loaders/PNTSLoaderBase.js","../src/core/renderer/loaders/CMPTLoaderBase.js"],"sourcesContent":["/**\n * Returns the file extension of the path component of a URL\n * @param {string} url\n * @returns {string} null if no extension found\n */\nexport function getUrlExtension( url ) {\n\n\tif ( ! url ) {\n\n\t\treturn null;\n\n\t}\n\n\t// Find the last occurrence of '?' and '#' to handle query params and fragments\n\tlet endIndex = url.length;\n\tconst queryIndex = url.indexOf( '?' );\n\tconst fragmentIndex = url.indexOf( '#' );\n\tif ( queryIndex !== - 1 ) {\n\n\t\tendIndex = Math.min( endIndex, queryIndex );\n\n\t}\n\n\tif ( fragmentIndex !== - 1 ) {\n\n\t\tendIndex = Math.min( endIndex, fragmentIndex );\n\n\t}\n\n\t// Check if the string is just a hostname or whether the path does not end in an extension\n\tconst lastPeriodIndex = url.lastIndexOf( '.', endIndex );\n\tconst lastSlashIndex = url.lastIndexOf( '/', endIndex );\n\tconst protocolIndex = url.indexOf( '://' );\n\tconst isHostOnly = protocolIndex !== - 1 && protocolIndex + 2 === lastSlashIndex;\n\tif ( isHostOnly || lastPeriodIndex === - 1 || lastPeriodIndex < lastSlashIndex ) {\n\n\t\treturn null;\n\n\t}\n\n\treturn url.substring( lastPeriodIndex + 1, endIndex ) || null;\n\n}\n","import { LOADED, FAILED } from '../constants.js';\n\nconst viewErrorTarget = {\n\tinView: false,\n\terror: Infinity,\n\tdistanceFromCamera: Infinity,\n};\n\n// flag guiding the behavior of the traversal to load the siblings at the root of the\n// tileset or not. The spec seems to indicate \"true\" when using REPLACE define but\n// Cesium's behavior is \"false\".\n// See CesiumGS/3d-tiles#776\nconst LOAD_ROOT_SIBLINGS = true;\n\nfunction isDownloadFinished( value ) {\n\n\treturn value === LOADED || value === FAILED;\n\n}\n\n// Checks whether this tile was last used on the given frame.\nfunction isUsedThisFrame( tile, frameCount ) {\n\n\treturn tile.__lastFrameVisited === frameCount && tile.__used;\n\n}\n\nfunction areChildrenProcessed( tile ) {\n\n\treturn tile.__childrenProcessed === tile.children.length;\n\n}\n\nfunction canUnconditionallyRefine( tile ) {\n\n\treturn tile.__hasUnrenderableContent || ( tile.parent && tile.parent.geometricError < tile.geometricError );\n\n}\n\n// Resets the frame information for the given tile\nfunction resetFrameState( tile, renderer ) {\n\n\tif ( tile.__lastFrameVisited !== renderer.frameCount ) {\n\n\t\ttile.__lastFrameVisited = renderer.frameCount;\n\t\ttile.__used = false;\n\t\ttile.__inFrustum = false;\n\t\ttile.__isLeaf = false;\n\t\ttile.__visible = false;\n\t\ttile.__active = false;\n\t\ttile.__error = Infinity;\n\t\ttile.__distanceFromCamera = Infinity;\n\t\ttile.__allChildrenReady = false;\n\n\t\t// update tile frustum and error state\n\t\trenderer.calculateTileViewError( tile, viewErrorTarget );\n\t\ttile.__inFrustum = viewErrorTarget.inView;\n\t\ttile.__error = viewErrorTarget.error;\n\t\ttile.__distanceFromCamera = viewErrorTarget.distanceFromCamera;\n\n\t}\n\n}\n\n// Recursively mark tiles used down to the next layer, skipping external tilesets\nfunction recursivelyMarkUsed( tile, renderer, cacheOnly = false ) {\n\n\trenderer.ensureChildrenArePreprocessed( tile );\n\n\tresetFrameState( tile, renderer );\n\tmarkUsed( tile, renderer, cacheOnly );\n\n\t// don't traverse if the children have not been processed, yet but tileset content\n\t// should be considered to be \"replaced\" by the loaded children so await that here.\n\tif ( canUnconditionallyRefine( tile ) && areChildrenProcessed( tile ) ) {\n\n\t\tconst children = tile.children;\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\trecursivelyMarkUsed( children[ i ], renderer, cacheOnly );\n\n\t\t}\n\n\t}\n\n}\n\n// Recursively traverses to the next tiles with unloaded renderable content to load them\nfunction recursivelyLoadNextRenderableTiles( tile, renderer ) {\n\n\trenderer.ensureChildrenArePreprocessed( tile );\n\n\t// exit the recursion if the tile hasn't been used this frame\n\tif ( isUsedThisFrame( tile, renderer.frameCount ) ) {\n\n\t\t// queue this tile to download content\n\t\tif ( tile.__hasContent ) {\n\n\t\t\trenderer.queueTileForDownload( tile );\n\n\t\t}\n\n\t\tif ( areChildrenProcessed( tile ) ) {\n\n\t\t\t// queue any used child tiles\n\t\t\tconst children = tile.children;\n\t\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\t\trecursivelyLoadNextRenderableTiles( children[ i ], renderer );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n}\n\n// Mark a tile as being used by current view\nfunction markUsed( tile, renderer, cacheOnly = false ) {\n\n\tif ( tile.__used ) {\n\n\t\treturn;\n\n\t}\n\n\tif ( ! cacheOnly ) {\n\n\t\ttile.__used = true;\n\t\trenderer.stats.used ++;\n\n\t}\n\n\trenderer.markTileUsed( tile );\n\n\tif ( tile.__inFrustum === true ) {\n\n\t\trenderer.stats.inFrustum ++;\n\n\t}\n\n}\n\n// Returns whether the tile can be traversed to the next layer of children by checking the tile metrics\nfunction canTraverse( tile, renderer ) {\n\n\t// If we've met the error requirements then don't load further - if an external tileset is encountered,\n\t// though, then continue to refine.\n\tif ( tile.__error <= renderer.errorTarget && ! canUnconditionallyRefine( tile ) ) {\n\n\t\treturn false;\n\n\t}\n\n\t// Early out if we've reached the maximum allowed depth.\n\tif ( renderer.maxDepth > 0 && tile.__depth + 1 >= renderer.maxDepth ) {\n\n\t\treturn false;\n\n\t}\n\n\t// Early out if the children haven't been processed, yet\n\tif ( ! areChildrenProcessed( tile ) ) {\n\n\t\treturn false;\n\n\t}\n\n\treturn true;\n\n}\n\n// Determine which tiles are used by the renderer given the current camera configuration\nexport function markUsedTiles( tile, renderer ) {\n\n\t// determine frustum set is run first so we can ensure the preprocessing of all the necessary\n\t// child tiles has happened here.\n\trenderer.ensureChildrenArePreprocessed( tile );\n\n\tresetFrameState( tile, renderer );\n\n\tif ( ! tile.__inFrustum ) {\n\n\t\treturn;\n\n\t}\n\n\tif ( ! canTraverse( tile, renderer ) ) {\n\n\t\tmarkUsed( tile, renderer );\n\t\treturn;\n\n\t}\n\n\t// Traverse children and see if any children are in view.\n\tlet anyChildrenUsed = false;\n\tlet anyChildrenInFrustum = false;\n\tconst children = tile.children;\n\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\tconst c = children[ i ];\n\t\tmarkUsedTiles( c, renderer );\n\t\tanyChildrenUsed = anyChildrenUsed || isUsedThisFrame( c, renderer.frameCount );\n\t\tanyChildrenInFrustum = anyChildrenInFrustum || c.__inFrustum;\n\n\t}\n\n\t// If none of the children are visible in the frustum then there should be no reason to display this tile. We still mark\n\t// this tile and all children as \"used\" only in the cache (but not loaded) so they are not disposed, causing an oscillation\n\t// / flicker in the content.\n\tif ( tile.refine === 'REPLACE' && ! anyChildrenInFrustum && children.length !== 0 ) {\n\n\t\ttile.__inFrustum = false;\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\trecursivelyMarkUsed( children[ i ], renderer, true );\n\n\t\t}\n\n\t\treturn;\n\n\t}\n\n\t// wait until after the above condition to mark the traversed tile as used or not\n\tmarkUsed( tile, renderer );\n\n\t// If this is a tile that needs children loaded to refine then recursively load child\n\t// tiles until error is met\n\tif ( tile.refine === 'REPLACE' && ( anyChildrenUsed && tile.__depth !== 0 || LOAD_ROOT_SIBLINGS ) ) {\n\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\trecursivelyMarkUsed( children[ i ], renderer );\n\n\t\t}\n\n\t}\n\n}\n\n// Traverse and mark the tiles that are at the leaf nodes of the \"used\" tree.\nexport function markUsedSetLeaves( tile, renderer ) {\n\n\tconst frameCount = renderer.frameCount;\n\tif ( ! isUsedThisFrame( tile, frameCount ) ) {\n\n\t\treturn;\n\n\t}\n\n\t// This tile is a leaf if none of the children had been used.\n\tconst children = tile.children;\n\tlet anyChildrenUsed = false;\n\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\tconst c = children[ i ];\n\t\tanyChildrenUsed = anyChildrenUsed || isUsedThisFrame( c, frameCount );\n\n\t}\n\n\tif ( ! anyChildrenUsed ) {\n\n\t\ttile.__isLeaf = true;\n\n\t} else {\n\n\t\tlet allChildrenReady = true;\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\tconst c = children[ i ];\n\t\t\tmarkUsedSetLeaves( c, renderer );\n\n\t\t\tif ( isUsedThisFrame( c, frameCount ) ) {\n\n\t\t\t\t// Compute whether this child is _allowed_ to display by checking the geometric error relative to the parent tile to avoid holes.\n\t\t\t\t// If the child's geometric error is less than or equal to the parent's (or it has unrenderable content), we should NOT display the child to avoid holes.\n\t\t\t\t// Only display the child if its geometric error is greater than the parent's and it has renderable content.\n\t\t\t\t// Note that this behavior is undocumented in the 3d tiles specification and tilesets designed to take advantage of it may not work as expected\n\t\t\t\t// in other rendering systems.\n\t\t\t\t// See issue NASA-AMMOS/3DTilesRendererJS#1304\n\t\t\t\tconst childCanDisplay = ! canUnconditionallyRefine( c );\n\n\t\t\t\t// Consider a child to be ready to be displayed if\n\t\t\t\t// - the children's children have been loaded\n\t\t\t\t// - the tile content has loaded\n\t\t\t\t// - the tile is completely empty - ie has no children and no content\n\t\t\t\t// - the child tileset has tried to load but failed\n\t\t\t\tlet isChildReady =\n\t\t\t\t\t! c.__hasContent ||\n\t\t\t\t\t( c.__hasRenderableContent && isDownloadFinished( c.__loadingState ) ) ||\n\t\t\t\t\t( c.__hasUnrenderableContent && c.__loadingState === FAILED );\n\n\t\t\t\t// Consider this child ready if it can be displayed and is ready for display or all of it's children ready to be displayed\n\t\t\t\tisChildReady = ( childCanDisplay && isChildReady ) || c.__allChildrenReady;\n\n\t\t\t\tallChildrenReady = allChildrenReady && isChildReady;\n\n\t\t\t}\n\n\t\t}\n\n\t\ttile.__allChildrenReady = allChildrenReady;\n\n\t}\n\n}\n\n// TODO: revisit implementation\n// Skip past tiles we consider unrenderable because they are outside the error threshold.\nexport function markVisibleTiles( tile, renderer ) {\n\n\tconst stats = renderer.stats;\n\tif ( ! isUsedThisFrame( tile, renderer.frameCount ) ) {\n\n\t\treturn;\n\n\t}\n\n\t// Request the tile contents or mark it as visible if we've found a leaf.\n\tif ( tile.__isLeaf ) {\n\n\t\tif ( tile.__loadingState === LOADED ) {\n\n\t\t\tif ( tile.__inFrustum ) {\n\n\t\t\t\ttile.__visible = true;\n\t\t\t\tstats.visible ++;\n\n\t\t\t}\n\n\t\t\ttile.__active = true;\n\t\t\tstats.active ++;\n\n\t\t} else if ( tile.__hasContent ) {\n\n\t\t\trenderer.queueTileForDownload( tile );\n\n\t\t}\n\n\t\treturn;\n\n\t}\n\n\tconst children = tile.children;\n\tconst hasContent = tile.__hasContent;\n\tconst loadedContent = isDownloadFinished( tile.__loadingState ) && hasContent;\n\tconst errorRequirement = ( renderer.errorTarget + 1 ) * renderer.errorThreshold;\n\tconst meetsSSE = tile.__error <= errorRequirement;\n\tconst isAdditiveRefine = tile.refine === 'ADD';\n\n\t// TODO: the \"meetsSSE\" field can be removed when the \"errorThreshold\" field has been removed\n\n\t// Don't wait for all children tiles to load if this tileset has empty tiles at the root in order\n\t// to match Cesium's behavior\n\tconst allChildrenReady = tile.__allChildrenReady || ( tile.__depth === 0 && ! LOAD_ROOT_SIBLINGS );\n\n\t// If we've met the SSE requirements and we can load content then fire a fetch.\n\tif ( hasContent && ( meetsSSE || isAdditiveRefine ) ) {\n\n\t\trenderer.queueTileForDownload( tile );\n\n\t}\n\n\t// By this time only tiles that meet the screen space error requirements will be traversed. Only mark this\n\t// as visible if it's been loaded and not all children have loaded yet or it's an additive tile, meaning it needs\n\t// to display in addition to the children.\n\n\t// Skip the tile entirely if there's no content to load\n\tif ( meetsSSE && loadedContent && ! allChildrenReady || loadedContent && isAdditiveRefine ) {\n\n\t\tif ( tile.__inFrustum ) {\n\n\t\t\ttile.__visible = true;\n\t\t\tstats.visible ++;\n\n\t\t}\n\n\t\ttile.__active = true;\n\t\tstats.active ++;\n\n\t}\n\n\t// If we're additive then don't stop the traversal here because it doesn't matter whether the children load in\n\t// at the same rate.\n\tif ( ! isAdditiveRefine && meetsSSE && ! allChildrenReady ) {\n\n\t\t// load the child content if we've found that we've been loaded so we can move down to the next tile\n\t\t// layer when the data has loaded.\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\tconst c = children[ i ];\n\t\t\tif ( isUsedThisFrame( c, renderer.frameCount ) ) {\n\n\t\t\t\trecursivelyLoadNextRenderableTiles( c, renderer );\n\n\t\t\t}\n\n\t\t}\n\n\t} else {\n\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\tmarkVisibleTiles( children[ i ], renderer );\n\n\t\t}\n\n\t}\n\n}\n\n// Final traverse to toggle tile visibility.\nexport function toggleTiles( tile, renderer ) {\n\n\tconst isUsed = isUsedThisFrame( tile, renderer.frameCount );\n\tif ( isUsed || tile.__usedLastFrame ) {\n\n\t\tlet setActive = false;\n\t\tlet setVisible = false;\n\t\tif ( isUsed ) {\n\n\t\t\t// enable visibility if active due to shadows\n\t\t\tsetActive = tile.__active;\n\t\t\tif ( renderer.displayActiveTiles ) {\n\n\t\t\t\tsetVisible = tile.__active || tile.__visible;\n\n\t\t\t} else {\n\n\t\t\t\tsetVisible = tile.__visible;\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\t// if the tile was used last frame but not this one then there's potential for the tile\n\t\t\t// to not have been visited during the traversal, meaning it hasn't been reset and has\n\t\t\t// stale values. This ensures the values are not stale.\n\t\t\tresetFrameState( tile, renderer );\n\n\t\t}\n\n\t\t// If the active or visible state changed then call the functions.\n\t\tif ( tile.__hasRenderableContent && tile.__loadingState === LOADED ) {\n\n\t\t\tif ( tile.__wasSetActive !== setActive ) {\n\n\t\t\t\trenderer.invokeOnePlugin( plugin => plugin.setTileActive && plugin.setTileActive( tile, setActive ) );\n\n\t\t\t}\n\n\t\t\tif ( tile.__wasSetVisible !== setVisible ) {\n\n\t\t\t\trenderer.invokeOnePlugin( plugin => plugin.setTileVisible && plugin.setTileVisible( tile, setVisible ) );\n\n\t\t\t}\n\n\t\t}\n\n\t\ttile.__wasSetActive = setActive;\n\t\ttile.__wasSetVisible = setVisible;\n\t\ttile.__usedLastFrame = isUsed;\n\n\t\tconst children = tile.children;\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\tconst c = children[ i ];\n\t\t\ttoggleTiles( c, renderer );\n\n\t\t}\n\n\t}\n\n}\n","// function that rate limits the amount of time a function can be called to once\n// per frame, initially queuing a new call for the next frame.\nexport function throttle( callback ) {\n\n\tlet handle = null;\n\treturn () => {\n\n\t\tif ( handle === null ) {\n\n\t\t\thandle = requestAnimationFrame( () => {\n\n\t\t\t\thandle = null;\n\t\t\t\tcallback();\n\n\t\t\t} );\n\n\t\t}\n\n\t};\n\n}\n","import { getUrlExtension } from '../utilities/urlExtension.js';\nimport { LRUCache } from '../utilities/LRUCache.js';\nimport { PriorityQueue } from '../utilities/PriorityQueue.js';\nimport { markUsedTiles, toggleTiles, markVisibleTiles, markUsedSetLeaves } from './traverseFunctions.js';\nimport { UNLOADED, LOADING, PARSING, LOADED, FAILED } from '../constants.js';\nimport { throttle } from '../utilities/throttle.js';\nimport { traverseSet } from '../utilities/TraversalUtils.js';\n\nconst PLUGIN_REGISTERED = Symbol( 'PLUGIN_REGISTERED' );\n\n// priority queue sort function that takes two tiles to compare. Returning 1 means\n// \"tile a\" is loaded first.\nconst priorityCallback = ( a, b ) => {\n\n\tconst aPriority = a.priority || 0;\n\tconst bPriority = b.priority || 0;\n\n\tif ( aPriority !== bPriority ) {\n\n\t\t// lower priority value sorts first\n\t\treturn aPriority > bPriority ? 1 : - 1;\n\n\t} else if ( a.__used !== b.__used ) {\n\n\t\t// load tiles that have been used\n\t\treturn a.__used ? 1 : - 1;\n\n\t} else if ( a.__error !== b.__error ) {\n\n\t\t// load the tile with the higher error\n\t\treturn a.__error > b.__error ? 1 : - 1;\n\n\t} else if ( a.__distanceFromCamera !== b.__distanceFromCamera ) {\n\n\t\t// and finally visible tiles which have equal error (ex: if geometricError === 0)\n\t\t// should prioritize based on distance.\n\t\treturn a.__distanceFromCamera > b.__distanceFromCamera ? - 1 : 1;\n\n\t} else if ( a.__depthFromRenderedParent !== b.__depthFromRenderedParent ) {\n\n\t\treturn a.__depthFromRenderedParent > b.__depthFromRenderedParent ? - 1 : 1;\n\n\t}\n\n\treturn 0;\n\n};\n\n// lru cache unload callback that takes two tiles to compare. Returning 1 means \"tile a\"\n// is unloaded first.\nconst lruPriorityCallback = ( a, b ) => {\n\n\tconst aPriority = a.priority || 0;\n\tconst bPriority = b.priority || 0;\n\n\tif ( aPriority !== bPriority ) {\n\n\t\t// lower priority value sorts first\n\t\treturn aPriority > bPriority ? 1 : - 1;\n\n\t} else if ( a.__lastFrameVisited !== b.__lastFrameVisited ) {\n\n\t\t// dispose of least recent tiles first\n\t\treturn a.__lastFrameVisited > b.__lastFrameVisited ? - 1 : 1;\n\n\t} else if ( a.__depthFromRenderedParent !== b.__depthFromRenderedParent ) {\n\n\t\t// dispose of deeper tiles first so parents are not disposed before children\n\t\treturn a.__depthFromRenderedParent > b.__depthFromRenderedParent ? 1 : - 1;\n\n\t} else if ( a.__loadingState !== b.__loadingState ) {\n\n\t\t// dispose of tiles that are earlier along in the loading process first\n\t\treturn a.__loadingState > b.__loadingState ? - 1 : 1;\n\n\t} else if ( a.__hasUnrenderableContent !== b.__hasUnrenderableContent ) {\n\n\t\t// dispose of external tilesets last\n\t\treturn a.__hasUnrenderableContent ? - 1 : 1;\n\n\t} else if ( a.__error !== b.__error ) {\n\n\t\t// unload the tile with lower error\n\t\treturn a.__error > b.__error ? - 1 : 1;\n\n\t}\n\n\treturn 0;\n\n};\n\nexport class TilesRendererBase {\n\n\tget root() {\n\n\t\tconst tileset = this.rootTileset;\n\t\treturn tileset ? tileset.root : null;\n\n\t}\n\n\tget rootTileSet() {\n\n\t\tconsole.warn( 'TilesRenderer: \"rootTileSet\" has been deprecated. Use \"rootTileset\" instead.' );\n\t\treturn this.rootTileset;\n\n\t}\n\n\tget loadProgress() {\n\n\t\tconst { stats, isLoading } = this;\n\t\tconst loading = stats.downloading + stats.parsing;\n\t\tconst total = stats.inCacheSinceLoad + ( isLoading ? 1 : 0 );\n\t\treturn total === 0 ? 1.0 : 1.0 - loading / total;\n\n\t}\n\n\tget errorThreshold() {\n\n\t\treturn this._errorThreshold;\n\n\t}\n\n\tset errorThreshold( v ) {\n\n\t\tconsole.warn( 'TilesRenderer: The \"errorThreshold\" option has been deprecated.' );\n\t\tthis._errorThreshold = v;\n\n\t}\n\n\tconstructor( url = null, cachedRootJson = null ) {\n\n\t\t// state\n\t\tthis.rootLoadingState = UNLOADED;\n\t\tthis.rootTileset = null;\n\t\tthis.rootURL = url;\n\t\tthis.cachedRootJson = cachedRootJson;\n\t\tthis.fetchOptions = {};\n\t\tthis.plugins = [];\n\t\tthis.queuedTiles = [];\n\t\tthis.cachedSinceLoadComplete = new Set();\n\t\tthis.isLoading = false;\n\n\t\tconst lruCache = new LRUCache();\n\t\tlruCache.unloadPriorityCallback = lruPriorityCallback;\n\n\t\tconst downloadQueue = new PriorityQueue();\n\t\tdownloadQueue.maxJobs = 25;\n\t\tdownloadQueue.priorityCallback = priorityCallback;\n\n\t\tconst parseQueue = new PriorityQueue();\n\t\tparseQueue.maxJobs = 5;\n\t\tparseQueue.priorityCallback = priorityCallback;\n\n\t\tconst processNodeQueue = new PriorityQueue();\n\t\tprocessNodeQueue.maxJobs = 25;\n\n\t\tthis.processedTiles = new WeakSet();\n\t\tthis.visibleTiles = new Set();\n\t\tthis.activeTiles = new Set();\n\t\tthis.usedSet = new Set();\n\t\tthis.lruCache = lruCache;\n\t\tthis.downloadQueue = downloadQueue;\n\t\tthis.parseQueue = parseQueue;\n\t\tthis.processNodeQueue = processNodeQueue;\n\t\tthis.stats = {\n\t\t\tinCacheSinceLoad: 0,\n\t\t\tinCache: 0,\n\t\t\tparsing: 0,\n\t\t\tdownloading: 0,\n\t\t\tfailed: 0,\n\t\t\tinFrustum: 0,\n\t\t\tused: 0,\n\t\t\tactive: 0,\n\t\t\tvisible: 0,\n\t\t};\n\t\tthis.frameCount = 0;\n\n\t\t// callbacks\n\t\tthis._dispatchNeedsUpdateEvent = throttle( () => {\n\n\t\t\tthis.dispatchEvent( { type: 'needs-update' } );\n\n\t\t} );\n\n\t\t// options\n\t\tthis.errorTarget = 16.0;\n\t\tthis._errorThreshold = Infinity;\n\t\tthis.displayActiveTiles = false;\n\t\tthis.maxDepth = Infinity;\n\n\t}\n\n\t// Plugins\n\tregisterPlugin( plugin ) {\n\n\t\tif ( plugin[ PLUGIN_REGISTERED ] === true ) {\n\n\t\t\tthrow new Error( 'TilesRendererBase: A plugin can only be registered to a single tileset' );\n\n\t\t}\n\n\t\t// warn if plugin implements deprecated loadRootTileSet method\n\t\tif ( plugin.loadRootTileSet && ! plugin.loadRootTileset ) {\n\n\t\t\tconsole.warn( 'TilesRendererBase: Plugin implements deprecated \"loadRootTileSet\" method. Please rename to \"loadRootTileset\".' );\n\t\t\tplugin.loadRootTileset = plugin.loadRootTileSet;\n\n\t\t}\n\n\t\tif ( plugin.preprocessTileSet && ! plugin.preprocessTileset ) {\n\n\t\t\tconsole.warn( 'TilesRendererBase: Plugin implements deprecated \"preprocessTileSet\" method. Please rename to \"preprocessTileset\".' );\n\t\t\tplugin.preprocessTileset = plugin.preprocessTileSet;\n\n\t\t}\n\n\t\t// insert the plugin based on the priority registered on the plugin\n\t\tconst plugins = this.plugins;\n\t\tconst priority = plugin.priority || 0;\n\t\tlet insertionPoint = plugins.length;\n\t\tfor ( let i = 0; i < plugins.length; i ++ ) {\n\n\t\t\tconst otherPriority = plugins[ i ].priority || 0;\n\t\t\tif ( otherPriority > priority ) {\n\n\t\t\t\tinsertionPoint = i;\n\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t}\n\n\t\tplugins.splice( insertionPoint, 0, plugin );\n\t\tplugin[ PLUGIN_REGISTERED ] = true;\n\t\tif ( plugin.init ) {\n\n\t\t\tplugin.init( this );\n\n\t\t}\n\n\t}\n\n\tunregisterPlugin( plugin ) {\n\n\t\tconst plugins = this.plugins;\n\t\tif ( typeof plugin === 'string' ) {\n\n\t\t\tplugin = this.getPluginByName( plugin );\n\n\t\t}\n\n\t\tif ( plugins.includes( plugin ) ) {\n\n\t\t\tconst index = plugins.indexOf( plugin );\n\t\t\tplugins.splice( index, 1 );\n\t\t\tif ( plugin.dispose ) {\n\n\t\t\t\tplugin.dispose();\n\n\t\t\t}\n\n\t\t\treturn true;\n\n\t\t}\n\n\t\treturn false;\n\n\t}\n\n\tgetPluginByName( name ) {\n\n\t\treturn this.plugins.find( p => p.name === name ) || null;\n\n\t}\n\n\tinvokeOnePlugin( func ) {\n\n\t\tconst plugins = [ ...this.plugins, this ];\n\t\tfor ( let i = 0; i < plugins.length; i ++ ) {\n\n\t\t\tconst result = func( plugins[ i ] );\n\t\t\tif ( result ) {\n\n\t\t\t\treturn result;\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn null;\n\n\t}\n\n\tinvokeAllPlugins( func ) {\n\n\t\tconst plugins = [ ...this.plugins, this ];\n\t\tconst pending = [];\n\t\tfor ( let i = 0; i < plugins.length; i ++ ) {\n\n\t\t\tconst result = func( plugins[ i ] );\n\t\t\tif ( result ) {\n\n\t\t\t\tpending.push( result );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn pending.length === 0 ? null : Promise.all( pending );\n\n\t}\n\n\t// Public API\n\ttraverse( beforecb, aftercb, ensureFullyProcessed = true ) {\n\n\t\tif ( ! this.root ) return;\n\n\t\ttraverseSet( this.root, ( tile, ...args ) => {\n\n\t\t\tif ( ensureFullyProcessed ) {\n\n\t\t\t\tthis.ensureChildrenArePreprocessed( tile, true );\n\n\t\t\t}\n\n\t\t\treturn beforecb ? beforecb( tile, ...args ) : false;\n\n\t\t}, aftercb );\n\n\t}\n\n\tgetAttributions( target = [] ) {\n\n\t\tthis.invokeAllPlugins( plugin => plugin !== this && plugin.getAttributions && plugin.getAttributions( target ) );\n\t\treturn target;\n\n\t}\n\n\tupdate() {\n\n\t\tconst { lruCache, usedSet, stats, root, downloadQueue, parseQueue, processNodeQueue } = this;\n\t\tif ( this.rootLoadingState === UNLOADED ) {\n\n\t\t\tthis.rootLoadingState = LOADING;\n\t\t\tthis.invokeOnePlugin( plugin => plugin.loadRootTileset && plugin.loadRootTileset() )\n\t\t\t\t.then( root => {\n\n\t\t\t\t\tlet processedUrl = this.rootURL;\n\t\t\t\t\tif ( processedUrl !== null ) {\n\n\t\t\t\t\t\tthis.invokeAllPlugins( plugin => processedUrl = plugin.preprocessURL ? plugin.preprocessURL( processedUrl, null ) : processedUrl );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.rootLoadingState = LOADED;\n\t\t\t\t\tthis.rootTileset = root;\n\t\t\t\t\tthis.dispatchEvent( { type: 'needs-update' } );\n\t\t\t\t\tthis.dispatchEvent( { type: 'load-content' } );\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-tileset',\n\t\t\t\t\t\ttileset: root,\n\t\t\t\t\t\turl: processedUrl,\n\t\t\t\t\t} );\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-root-tileset',\n\t\t\t\t\t\ttileset: root,\n\t\t\t\t\t\turl: processedUrl,\n\t\t\t\t\t} );\n\n\t\t\t\t} )\n\t\t\t\t.catch( error => {\n\n\t\t\t\t\tthis.rootLoadingState = FAILED;\n\t\t\t\t\tconsole.error( error );\n\n\t\t\t\t\tthis.rootTileset = null;\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-error',\n\t\t\t\t\t\ttile: null,\n\t\t\t\t\t\terror,\n\t\t\t\t\t\turl: this.rootURL,\n\t\t\t\t\t} );\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\tif ( ! root ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tstats.inFrustum = 0;\n\t\tstats.used = 0;\n\t\tstats.active = 0;\n\t\tstats.visible = 0;\n\t\tthis.frameCount ++;\n\n\t\tusedSet.forEach( tile => lruCache.markUnused( tile ) );\n\t\tusedSet.clear();\n\n\t\tmarkUsedTiles( root, this );\n\t\tmarkUsedSetLeaves( root, this );\n\t\tmarkVisibleTiles( root, this );\n\t\ttoggleTiles( root, this );\n\n\t\t// TODO: This will only sort for one tileset. We may want to store this queue on the\n\t\t// LRUCache so multiple tilesets can use it at once\n\t\t// start the downloads of the tiles as needed\n\t\tconst queuedTiles = this.queuedTiles;\n\t\tqueuedTiles.sort( lruCache.unloadPriorityCallback );\n\t\tfor ( let i = 0, l = queuedTiles.length; i < l && ! lruCache.isFull(); i ++ ) {\n\n\t\t\tthis.requestTileContents( queuedTiles[ i ] );\n\n\t\t}\n\n\t\tqueuedTiles.length = 0;\n\n\t\t// start the downloads\n\t\tlruCache.scheduleUnload();\n\n\t\t// if all tasks have finished and we've been marked as actively loading then fire the completion event\n\t\tconst runningTasks = downloadQueue.running || parseQueue.running || processNodeQueue.running;\n\t\tif ( runningTasks === false && this.isLoading === true ) {\n\n\t\t\tthis.cachedSinceLoadComplete.clear();\n\t\t\tstats.inCacheSinceLoad = 0;\n\n\t\t\tthis.dispatchEvent( { type: 'tiles-load-end' } );\n\t\t\tthis.isLoading = false;\n\n\t\t}\n\n\t}\n\n\tresetFailedTiles() {\n\n\t\t// reset the root tile if it's finished but never loaded\n\t\tif ( this.rootLoadingState === FAILED ) {\n\n\t\t\tthis.rootLoadingState = UNLOADED;\n\n\t\t}\n\n\t\tconst stats = this.stats;\n\t\tif ( stats.failed === 0 ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tthis.traverse( tile => {\n\n\t\t\tif ( tile.__loadingState === FAILED ) {\n\n\t\t\t\ttile.__loadingState = UNLOADED;\n\n\t\t\t}\n\n\t\t}, null, false );\n\n\t\tstats.failed = 0;\n\n\t}\n\n\tdispose() {\n\n\t\t// dispose of all the plugins\n\t\tconst plugins = [ ...this.plugins ];\n\t\tplugins.forEach( plugin => {\n\n\t\t\tthis.unregisterPlugin( plugin );\n\n\t\t} );\n\n\t\tconst lruCache = this.lruCache;\n\n\t\t// Make sure we've collected all children before disposing of the internal tilesets to avoid\n\t\t// dangling children that we inadvertantly skip when deleting the nested tileset.\n\t\tconst toRemove = [];\n\t\tthis.traverse( t => {\n\n\t\t\ttoRemove.push( t );\n\t\t\treturn false;\n\n\t\t}, null, false );\n\t\tfor ( let i = 0, l = toRemove.length; i < l; i ++ ) {\n\n\t\t\tlruCache.remove( toRemove[ i ] );\n\n\t\t}\n\n\t\tthis.stats = {\n\t\t\tparsing: 0,\n\t\t\tdownloading: 0,\n\t\t\tfailed: 0,\n\t\t\tinFrustum: 0,\n\t\t\tused: 0,\n\t\t\tactive: 0,\n\t\t\tvisible: 0,\n\t\t};\n\t\tthis.frameCount = 0;\n\n\t}\n\n\t// Overrideable\n\tcalculateBytesUsed( scene, tile ) {\n\n\t\treturn 0;\n\n\t}\n\n\tdispatchEvent( e ) {}\n\n\taddEventListener( name, callback ) {}\n\n\tremoveEventListener( name, callback ) {}\n\n\tparseTile( buffer, tile, extension ) {\n\n\t\treturn null;\n\n\t}\n\n\tdisposeTile( tile ) {\n\n\t\t// TODO: are these necessary? Are we disposing tiles when they are currently visible?\n\t\tif ( tile.__visible ) {\n\n\t\t\tthis.invokeOnePlugin( plugin => plugin.setTileVisible && plugin.setTileVisible( tile, false ) );\n\t\t\ttile.__visible = false;\n\n\t\t}\n\n\t\tif ( tile.__active ) {\n\n\t\t\tthis.invokeOnePlugin( plugin => plugin.setTileActive && plugin.setTileActive( tile, false ) );\n\t\t\ttile.__active = false;\n\n\t\t}\n\n\t}\n\n\tpreprocessNode( tile, tilesetDir, parentTile = null ) {\n\n\t\tthis.processedTiles.add( tile );\n\n\t\tif ( tile.content ) {\n\n\t\t\t// Fix old file formats\n\t\t\tif ( ! ( 'uri' in tile.content ) && 'url' in tile.content ) {\n\n\t\t\t\ttile.content.uri = tile.content.url;\n\t\t\t\tdelete tile.content.url;\n\n\t\t\t}\n\n\t\t\t// NOTE: fix for some cases where tilesets provide the bounding volume\n\t\t\t// but volumes are not present.\n\t\t\tif (\n\t\t\t\ttile.content.boundingVolume &&\n\t\t\t\t! (\n\t\t\t\t\t'box' in tile.content.boundingVolume ||\n\t\t\t\t\t'sphere' in tile.content.boundingVolume ||\n\t\t\t\t\t'region' in tile.content.boundingVolume\n\t\t\t\t)\n\t\t\t) {\n\n\t\t\t\tdelete tile.content.boundingVolume;\n\n\t\t\t}\n\n\t\t}\n\n\t\ttile.parent = parentTile;\n\t\ttile.children = tile.children || [];\n\n\t\tif ( tile.content?.uri ) {\n\n\t\t\t// \"content\" should only indicate loadable meshes, not external tilesets\n\t\t\tconst extension = getUrlExtension( tile.content.uri );\n\n\t\t\ttile.__hasContent = true;\n\t\t\ttile.__hasUnrenderableContent = Boolean( extension && /json$/.test( extension ) );\n\t\t\ttile.__hasRenderableContent = ! tile.__hasUnrenderableContent;\n\n\t\t} else {\n\n\t\t\ttile.__hasContent = false;\n\t\t\ttile.__hasUnrenderableContent = false;\n\t\t\ttile.__hasRenderableContent = false;\n\n\t\t}\n\n\t\t// tracker for determining if all the children have been asynchronously\n\t\t// processed and are ready to be traversed\n\t\ttile.__childrenProcessed = 0;\n\t\tif ( parentTile ) {\n\n\t\t\tparentTile.__childrenProcessed ++;\n\n\t\t}\n\n\t\ttile.__distanceFromCamera = Infinity;\n\t\ttile.__error = Infinity;\n\n\t\ttile.__inFrustum = false;\n\t\ttile.__isLeaf = false;\n\n\t\ttile.__usedLastFrame = false;\n\t\ttile.__used = false;\n\n\t\ttile.__wasSetVisible = false;\n\t\ttile.__visible = false;\n\t\ttile.__allChildrenReady = false;\n\n\t\ttile.__wasSetActive = false;\n\t\ttile.__active = false;\n\n\t\ttile.__loadingState = UNLOADED;\n\n\t\tif ( parentTile === null ) {\n\n\t\t\ttile.__depth = 0;\n\t\t\ttile.__depthFromRenderedParent = ( tile.__hasRenderableContent ? 1 : 0 );\n\t\t\ttile.refine = tile.refine || 'REPLACE';\n\n\t\t} else {\n\n\t\t\t// increment the \"depth from parent\" when we encounter a new tile with content\n\t\t\ttile.__depth = parentTile.__depth + 1;\n\t\t\ttile.__depthFromRenderedParent = parentTile.__depthFromRenderedParent + ( tile.__hasRenderableContent ? 1 : 0 );\n\n\t\t\ttile.refine = tile.refine || parentTile.refine;\n\n\t\t}\n\n\t\ttile.__basePath = tilesetDir;\n\n\t\ttile.__lastFrameVisited = - 1;\n\n\t\tthis.invokeAllPlugins( plugin => {\n\n\t\t\tplugin !== this && plugin.preprocessNode && plugin.preprocessNode( tile, tilesetDir, parentTile );\n\n\t\t} );\n\n\t}\n\n\tsetTileActive( tile, active ) {\n\n\t\tactive ? this.activeTiles.add( tile ) : this.activeTiles.delete( tile );\n\n\t}\n\n\tsetTileVisible( tile, visible ) {\n\n\t\tvisible ? this.visibleTiles.add( tile ) : this.visibleTiles.delete( tile );\n\n\t}\n\n\tcalculateTileViewError( tile, target ) {\n\n\t\t// retrieve whether the tile is visible, screen space error, and distance to camera\n\t\t// set \"inView\", \"error\", \"distance\"\n\n\t}\n\n\t// Private Functions\n\tqueueTileForDownload( tile ) {\n\n\t\tif ( tile.__loadingState !== UNLOADED || this.lruCache.isFull() ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tthis.queuedTiles.push( tile );\n\n\t}\n\n\tmarkTileUsed( tile ) {\n\n\t\t// save the tile in a separate \"used set\" so we can mark it as unused\n\t\t// before the next tileset traversal\n\t\tthis.usedSet.add( tile );\n\t\tthis.lruCache.markUsed( tile );\n\n\t}\n\n\tfetchData( url, options ) {\n\n\t\treturn fetch( url, options );\n\n\t}\n\n\tensureChildrenArePreprocessed( tile, immediate = false ) {\n\n\t\tconst children = tile.children;\n\t\tfor ( let i = 0, l = children.length; i < l; i ++ ) {\n\n\t\t\tconst child = children[ i ];\n\t\t\tif ( '__depth' in child ) {\n\n\t\t\t\t// the child has already been processed\n\t\t\t\tbreak;\n\n\t\t\t} else if ( immediate ) {\n\n\t\t\t\t// process the node immediately and make sure we don't double process it\n\t\t\t\tthis.processNodeQueue.remove( child );\n\t\t\t\tthis.preprocessNode( child, tile.__basePath, tile );\n\n\t\t\t} else {\n\n\t\t\t\t// queue the node for processing if it hasn't been already\n\t\t\t\tif ( ! this.processNodeQueue.has( child ) ) {\n\n\t\t\t\t\tthis.processNodeQueue.add( child, child => {\n\n\t\t\t\t\t\tthis.preprocessNode( child, tile.__basePath, tile );\n\t\t\t\t\t\tthis._dispatchNeedsUpdateEvent();\n\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t// returns the total bytes used for by the given tile as reported by all plugins\n\tgetBytesUsed( tile ) {\n\n\t\tlet bytes = 0;\n\t\tthis.invokeAllPlugins( plugin => {\n\n\t\t\tif ( plugin.calculateBytesUsed ) {\n\n\t\t\t\tbytes += plugin.calculateBytesUsed( tile, tile.cached.scene ) || 0;\n\n\t\t\t}\n\n\t\t} );\n\n\t\treturn bytes;\n\n\t}\n\n\t// force a recalculation of the tile or all tiles if no tile is provided\n\trecalculateBytesUsed( tile = null ) {\n\n\t\tconst { lruCache, processedTiles } = this;\n\t\tif ( tile === null ) {\n\n\t\t\tlruCache.itemSet.forEach( item => {\n\n\t\t\t\tif ( processedTiles.has( item ) ) {\n\n\t\t\t\t\tlruCache.setMemoryUsage( item, this.getBytesUsed( item ) );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t} else {\n\n\t\t\tlruCache.setMemoryUsage( tile, this.getBytesUsed( tile ) );\n\n\t\t}\n\n\t}\n\n\tpreprocessTileset( json, url, parent = null ) {\n\n\t\t// check for deprecated function usage\n\t\tconst proto = Object.getPrototypeOf( this );\n\t\tif ( Object.hasOwn( proto, 'preprocessTileSet' ) ) {\n\n\t\t\tconsole.warn( `${ proto.constructor.name }: Class overrides deprecated \"preprocessTileSet\" method. Please rename to \"preprocessTileset\".` );\n\n\t\t}\n\n\t\tconst version = json.asset.version;\n\t\tconst [ major, minor ] = version.split( '.' ).map( v => parseInt( v ) );\n\t\tconsole.assert(\n\t\t\tmajor <= 1,\n\t\t\t'TilesRenderer: asset.version is expected to be a 1.x or a compatible version.',\n\t\t);\n\n\t\tif ( major === 1 && minor > 0 ) {\n\n\t\t\tconsole.warn( 'TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.' );\n\n\t\t}\n\n\t\t// remove the last file path path-segment from the URL including the trailing slash\n\t\tlet basePath = url.replace( /\\/[^/]*$/, '' );\n\t\tbasePath = new URL( basePath, window.location.href ).toString();\n\t\tthis.preprocessNode( json.root, basePath, parent );\n\n\t}\n\n\tpreprocessTileSet( ...args ) {\n\n\t\tconsole.warn( 'TilesRenderer: \"preprocessTileSet\" has been deprecated. Use \"preprocessTileset\" instead.' );\n\t\treturn this.preprocessTileset( ...args );\n\n\t}\n\n\tloadRootTileset() {\n\n\t\t// check for deprecated function usage\n\t\tconst proto = Object.getPrototypeOf( this );\n\t\tif ( Object.hasOwn( proto, 'loadRootTileSet' ) ) {\n\n\t\t\tconsole.warn( `${ proto.constructor.name }: Class overrides deprecated \"loadRootTileSet\" method. Please rename to \"loadRootTileset\".` );\n\n\t\t}\n\n\t\t// transform the url\n\t\tlet processedUrl = this.rootURL;\n\t\tthis.invokeAllPlugins( plugin => processedUrl = plugin.preprocessURL ? plugin.preprocessURL( processedUrl, null ) : processedUrl );\n\n\t\tif ( this.cachedRootJson ) {\n\n\t\t\treturn Promise.resolve( this.cachedRootJson )\n\t\t\t\t.then( root => {\n\n\t\t\t\t\tthis.preprocessTileset( root, processedUrl );\n\t\t\t\t\treturn root;\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\t// load the tileset root\n\t\tconst pr = this\n\t\t\t.invokeOnePlugin( plugin => plugin.fetchData && plugin.fetchData( processedUrl, this.fetchOptions ) )\n\t\t\t.then( res => {\n\n\t\t\t\tif ( ! ( res instanceof Response ) ) {\n\n\t\t\t\t\treturn res;\n\n\t\t\t\t} else if ( res.ok ) {\n\n\t\t\t\t\treturn res.json();\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthrow new Error( `TilesRenderer: Failed to load tileset \"${ processedUrl }\" with status ${ res.status } : ${ res.statusText }` );\n\n\t\t\t\t}\n\n\t\t\t} )\n\t\t\t.then( root => {\n\n\t\t\t\tthis.preprocessTileset( root, processedUrl );\n\t\t\t\treturn root;\n\n\t\t\t} );\n\n\t\treturn pr;\n\n\t}\n\n\tloadRootTileSet( ...args ) {\n\n\t\tconsole.warn( 'TilesRenderer: \"loadRootTileSet\" has been deprecated. Use \"loadRootTileset\" instead.' );\n\t\treturn this.loadRootTileSet( ...args );\n\n\t}\n\n\trequestTileContents( tile ) {\n\n\t\t// If the tile is already being loaded then don't\n\t\t// start it again.\n\t\tif ( tile.__loadingState !== UNLOADED ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tlet isExternalTileset = false;\n\t\tlet externalTileset = null;\n\t\tlet uri = new URL( tile.content.uri, tile.__basePath + '/' ).toString();\n\t\tthis.invokeAllPlugins( plugin => uri = plugin.preprocessURL ? plugin.preprocessURL( uri, tile ) : uri );\n\n\t\tconst stats = this.stats;\n\t\tconst lruCache = this.lruCache;\n\t\tconst downloadQueue = this.downloadQueue;\n\t\tconst parseQueue = this.parseQueue;\n\t\tconst extension = getUrlExtension( uri );\n\n\t\t// track an abort controller and pass-through the below conditions if aborted\n\t\tconst controller = new AbortController();\n\t\tconst signal = controller.signal;\n\t\tconst addedSuccessfully = lruCache.add( tile, t => {\n\n\t\t\t// Stop the load if it's started\n\t\t\tcontroller.abort();\n\n\t\t\t// Clear out all tile content\n\t\t\tif ( isExternalTileset ) {\n\n\t\t\t\tt.children.length = 0;\n\t\t\t\tt.__childrenProcessed = 0;\n\n\t\t\t} else {\n\n\t\t\t\tthis.invokeAllPlugins( plugin => {\n\n\t\t\t\t\tplugin.disposeTile && plugin.disposeTile( t );\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\t// Decrement stats\n\t\t\tstats.inCache --;\n\t\t\tif ( this.cachedSinceLoadComplete.has( tile ) ) {\n\n\t\t\t\tthis.cachedSinceLoadComplete.delete( tile );\n\t\t\t\tstats.inCacheSinceLoad --;\n\n\t\t\t}\n\n\t\t\tif ( t.__loadingState === LOADING ) {\n\n\t\t\t\tstats.downloading --;\n\n\t\t\t} else if ( t.__loadingState === PARSING ) {\n\n\t\t\t\tstats.parsing --;\n\n\t\t\t}\n\n\t\t\tt.__loadingState = UNLOADED;\n\n\t\t\tparseQueue.remove( t );\n\t\t\tdownloadQueue.remove( t );\n\n\t\t} );\n\n\t\t// if we couldn't add the tile to the lru cache because it's full then skip\n\t\tif ( ! addedSuccessfully ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\t// check if this is the beginning of a new set of tiles to load and dispatch and event\n\t\tif ( ! this.isLoading ) {\n\n\t\t\tthis.isLoading = true;\n\t\t\tthis.dispatchEvent( { type: 'tiles-load-start' } );\n\n\t\t}\n\n\t\tlruCache.setMemoryUsage( tile, this.getBytesUsed( tile ) );\n\t\tthis.cachedSinceLoadComplete.add( tile );\n\t\tstats.inCacheSinceLoad ++;\n\t\tstats.inCache ++;\n\t\tstats.downloading ++;\n\t\ttile.__loadingState = LOADING;\n\n\t\t// queue the download and parse\n\t\treturn downloadQueue.add( tile, downloadTile => {\n\n\t\t\tif ( signal.aborted ) {\n\n\t\t\t\treturn Promise.resolve();\n\n\t\t\t}\n\n\t\t\tconst res = this.invokeOnePlugin( plugin => plugin.fetchData && plugin.fetchData( uri, { ...this.fetchOptions, signal } ) );\n\t\t\tthis.dispatchEvent( { type: 'tile-download-start', tile, uri } );\n\t\t\treturn res;\n\n\t\t} )\n\t\t\t.then( res => {\n\n\t\t\t\tif ( signal.aborted ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tif ( ! ( res instanceof Response ) ) {\n\n\t\t\t\t\treturn res;\n\n\t\t\t\t} else if ( res.ok ) {\n\n\t\t\t\t\treturn extension === 'json' ? res.json() : res.arrayBuffer();\n\n\t\t\t\t} else {\n\n\t\t\t\t\tthrow new Error( `Failed to load model with error code ${res.status}` );\n\n\t\t\t\t}\n\n\t\t\t} )\n\t\t\t.then( content => {\n\n\t\t\t\t// if it has been unloaded then the tile has been disposed\n\t\t\t\tif ( signal.aborted ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tstats.downloading --;\n\t\t\t\tstats.parsing ++;\n\t\t\t\ttile.__loadingState = PARSING;\n\n\t\t\t\treturn parseQueue.add( tile, parseTile => {\n\n\t\t\t\t\t// if it has been unloaded then the tile has been disposed\n\t\t\t\t\tif ( signal.aborted ) {\n\n\t\t\t\t\t\treturn Promise.resolve();\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( extension === 'json' && content.root ) {\n\n\t\t\t\t\t\tthis.preprocessTileset( content, uri, tile );\n\t\t\t\t\t\ttile.children.push( content.root );\n\t\t\t\t\t\texternalTileset = content;\n\t\t\t\t\t\tisExternalTileset = true;\n\t\t\t\t\t\treturn Promise.resolve();\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\treturn this.invokeOnePlugin( plugin => plugin.parseTile && plugin.parseTile( content, parseTile, extension, uri, signal ) );\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\n\t\t\t} )\n\t\t\t.then( () => {\n\n\t\t\t\t// if it has been unloaded then the tile has been disposed\n\t\t\t\tif ( signal.aborted ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tstats.parsing --;\n\t\t\t\ttile.__loadingState = LOADED;\n\t\t\t\tlruCache.setLoaded( tile, true );\n\n\t\t\t\t// If the memory of the item hasn't been registered yet then that means the memory usage hasn't\n\t\t\t\t// been accounted for by the cache yet so we need to check if it fits or if we should remove it.\n\t\t\t\tconst bytesUsed = this.getBytesUsed( tile );\n\t\t\t\tif ( lruCache.getMemoryUsage( tile ) === 0 && bytesUsed > 0 && lruCache.isFull() ) {\n\n\t\t\t\t\t// And if the cache is full due to newly loaded memory then lets discard this tile - it will\n\t\t\t\t\t// be loaded again later from the disk cache if needed.\n\t\t\t\t\tlruCache.remove( tile );\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\t// update memory\n\t\t\t\tlruCache.setMemoryUsage( tile, bytesUsed );\n\n\t\t\t\t// dispatch an event indicating that this model has completed and that a new\n\t\t\t\t// call to \"update\" is needed.\n\t\t\t\tthis.dispatchEvent( { type: 'needs-update' } );\n\t\t\t\tthis.dispatchEvent( { type: 'load-content' } );\n\t\t\t\tif ( isExternalTileset ) {\n\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-tileset',\n\t\t\t\t\t\ttileset: externalTileset,\n\t\t\t\t\t\turl: uri,\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t\tif ( tile.cached.scene ) {\n\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-model',\n\t\t\t\t\t\tscene: tile.cached.scene,\n\t\t\t\t\t\ttile,\n\t\t\t\t\t\turl: uri,\n\t\t\t\t\t} );\n\n\t\t\t\t}\n\n\t\t\t} )\n\t\t\t.catch( error => {\n\n\t\t\t\t// if it has been unloaded then the tile has been disposed\n\t\t\t\tif ( signal.aborted ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\tif ( error.name !== 'AbortError' ) {\n\n\t\t\t\t\tparseQueue.remove( tile );\n\t\t\t\t\tdownloadQueue.remove( tile );\n\n\t\t\t\t\tif ( tile.__loadingState === PARSING ) {\n\n\t\t\t\t\t\tstats.parsing --;\n\n\t\t\t\t\t} else if ( tile.__loadingState === LOADING ) {\n\n\t\t\t\t\t\tstats.downloading --;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tstats.failed ++;\n\n\t\t\t\t\tconsole.error( `TilesRenderer : Failed to load tile at url \"${ tile.content.uri }\".` );\n\t\t\t\t\tconsole.error( error );\n\t\t\t\t\ttile.__loadingState = FAILED;\n\t\t\t\t\tlruCache.setLoaded( tile, true );\n\n\t\t\t\t\tthis.dispatchEvent( {\n\t\t\t\t\t\ttype: 'load-error',\n\t\t\t\t\t\ttile,\n\t\t\t\t\t\terror,\n\t\t\t\t\t\turl: uri,\n\t\t\t\t\t} );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tlruCache.remove( tile );\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t}\n\n}\n","import { arrayToString } from './LoaderUtils.js';\n\nexport function parseBinArray( buffer, arrayStart, count, type, componentType, propertyName ) {\n\n\tlet stride;\n\tswitch ( type ) {\n\n\t\tcase 'SCALAR':\n\t\t\tstride = 1;\n\t\t\tbreak;\n\n\t\tcase 'VEC2':\n\t\t\tstride = 2;\n\t\t\tbreak;\n\n\t\tcase 'VEC3':\n\t\t\tstride = 3;\n\t\t\tbreak;\n\n\t\tcase 'VEC4':\n\t\t\tstride = 4;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tthrow new Error( `FeatureTable : Feature type not provided for \"${ propertyName }\".` );\n\n\t}\n\n\tlet data;\n\tconst arrayLength = count * stride;\n\n\tswitch ( componentType ) {\n\n\t\tcase 'BYTE':\n\t\t\tdata = new Int8Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'UNSIGNED_BYTE':\n\t\t\tdata = new Uint8Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'SHORT':\n\t\t\tdata = new Int16Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'UNSIGNED_SHORT':\n\t\t\tdata = new Uint16Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'INT':\n\t\t\tdata = new Int32Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'UNSIGNED_INT':\n\t\t\tdata = new Uint32Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'FLOAT':\n\t\t\tdata = new Float32Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tcase 'DOUBLE':\n\t\t\tdata = new Float64Array( buffer, arrayStart, arrayLength );\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tthrow new Error( `FeatureTable : Feature component type not provided for \"${ propertyName }\".` );\n\n\t}\n\n\treturn data;\n\n}\n\nexport class FeatureTable {\n\n\tconstructor( buffer, start, headerLength, binLength ) {\n\n\t\tthis.buffer = buffer;\n\t\tthis.binOffset = start + headerLength;\n\t\tthis.binLength = binLength;\n\n\t\tlet header = null;\n\t\tif ( headerLength !== 0 ) {\n\n\t\t\tconst headerData = new Uint8Array( buffer, start, headerLength );\n\t\t\theader = JSON.parse( arrayToString( headerData ) );\n\n\t\t} else {\n\n\t\t\theader = {};\n\n\t\t}\n\n\t\tthis.header = header;\n\n\t}\n\n\tgetKeys() {\n\n\t\treturn Object.keys( this.header ).filter( key => key !== 'extensions' );\n\n\t}\n\n\tgetData( key, count, defaultComponentType = null, defaultType = null ) {\n\n\t\tconst header = this.header;\n\n\t\tif ( ! ( key in header ) ) {\n\n\t\t\treturn null;\n\n\t\t}\n\n\t\tconst feature = header[ key ];\n\t\tif ( ! ( feature instanceof Object ) ) {\n\n\t\t\treturn feature;\n\n\t\t} else if ( Array.isArray( feature ) ) {\n\n\t\t\treturn feature;\n\n\t\t} else {\n\n\t\t\tconst { buffer, binOffset, binLength } = this;\n\t\t\tconst byteOffset = feature.byteOffset || 0;\n\t\t\tconst featureType = feature.type || defaultType;\n\t\t\tconst featureComponentType = feature.componentType || defaultComponentType;\n\n\t\t\tif ( 'type' in feature && defaultType && feature.type !== defaultType ) {\n\n\t\t\t\tthrow new Error( 'FeatureTable: Specified type does not match expected type.' );\n\n\t\t\t}\n\n\t\t\tconst arrayStart = binOffset + byteOffset;\n\t\t\tconst data = parseBinArray( buffer, arrayStart, count, featureType, featureComponentType, key );\n\n\t\t\tconst dataEnd = arrayStart + data.byteLength;\n\t\t\tif ( dataEnd > binOffset + binLength ) {\n\n\t\t\t\tthrow new Error( 'FeatureTable: Feature data read outside binary body length.' );\n\n\t\t\t}\n\n\t\t\treturn data;\n\n\t\t}\n\n\t}\n\n\tgetBuffer( byteOffset, byteLength ) {\n\n\t\tconst { buffer, binOffset } = this;\n\t\treturn buffer.slice( binOffset + byteOffset, binOffset + byteOffset + byteLength );\n\n\t}\n\n}\n","import { parseBinArray } from './FeatureTable.js';\n\nexport class BatchTableHierarchyExtension {\n\n\tconstructor( batchTable ) {\n\n\t\tthis.batchTable = batchTable;\n\n\t\tconst extensionHeader = batchTable.header.extensions[ '3DTILES_batch_table_hierarchy' ];\n\n\t\tthis.classes = extensionHeader.classes;\n\t\tfor ( const classDef of this.classes ) {\n\n\t\t\tconst instances = classDef.instances;\n\t\t\tfor ( const property in instances ) {\n\n\t\t\t\tclassDef.instances[ property ] = this._parseProperty( instances[ property ], classDef.length, property );\n\n\t\t\t}\n\n\t\t}\n\n\t\tthis.instancesLength = extensionHeader.instancesLength;\n\n\t\tthis.classIds = this._parseProperty( extensionHeader.classIds, this.instancesLength, 'classIds' );\n\n\t\tif ( extensionHeader.parentCounts ) {\n\n\t\t\tthis.parentCounts = this._parseProperty( extensionHeader.parentCounts, this.instancesLength, 'parentCounts' );\n\n\t\t} else {\n\n\t\t\tthis.parentCounts = new Array( this.instancesLength ).fill( 1 );\n\n\t\t}\n\n\t\tif ( extensionHeader.parentIds ) {\n\n\t\t\tconst parentIdsLength = this.parentCounts.reduce( ( a, b ) => a + b, 0 );\n\t\t\tthis.parentIds = this._parseProperty( extensionHeader.parentIds, parentIdsLength, 'parentIds' );\n\n\t\t} else {\n\n\t\t\tthis.parentIds = null;\n\n\t\t}\n\n\t\tthis.instancesIds = [];\n\t\tconst classCounter = {};\n\t\tfor ( const classId of this.classIds ) {\n\n\t\t\tclassCounter[ classId ] = classCounter[ classId ] ?? 0;\n\t\t\tthis.instancesIds.push( classCounter[ classId ] );\n\t\t\tclassCounter[ classId ] ++;\n\n\t\t}\n\n\t}\n\n\t_parseProperty( property, propertyLength, propertyName ) {\n\n\t\tif ( Array.isArray( property ) ) {\n\n\t\t\treturn property;\n\n\t\t} else {\n\n\t\t\tconst { buffer, binOffset } = this.batchTable;\n\n\t\t\tconst byteOffset = property.byteOffset;\n\t\t\tconst componentType = property.componentType || 'UNSIGNED_SHORT';\n\n\t\t\tconst arrayStart = binOffset + byteOffset;\n\n\t\t\treturn parseBinArray( buffer, arrayStart, propertyLength, 'SCALAR', componentType, propertyName );\n\n\t\t}\n\n\t}\n\n\tgetDataFromId( id, target = {} ) {\n\n\t\t// Get properties inherited from parents\n\n\t\tconst parentCount = this.parentCounts[ id ];\n\n\t\tif ( this.parentIds && parentCount > 0 ) {\n\n\t\t\tlet parentIdsOffset = 0;\n\t\t\tfor ( let i = 0; i < id; i ++ ) {\n\n\t\t\t\tparentIdsOffset += this.parentCounts[ i ];\n\n\t\t\t}\n\n\t\t\tfor ( let i = 0; i < parentCount; i ++ ) {\n\n\t\t\t\tconst parentId = this.parentIds[ parentIdsOffset + i ];\n\t\t\t\tif ( parentId !== id ) {\n\n\t\t\t\t\tthis.getDataFromId( parentId, target );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// Get properties proper to this instance\n\n\t\tconst classId = this.classIds[ id ];\n\t\tconst instances = this.classes[ classId ].instances;\n\t\tconst className = this.classes[ classId ].name;\n\t\tconst instanceId = this.instancesIds[ id ];\n\n\t\tfor ( const key in instances ) {\n\n\t\t\ttarget[ className ] = target[ className ] || {};\n\t\t\ttarget[ className ][ key ] = instances[ key ][ instanceId ];\n\n\t\t}\n\n\t\treturn target;\n\n\t}\n\n}\n","import { BatchTableHierarchyExtension } from './BatchTableHierarchyExtension.js';\nimport { FeatureTable } from './FeatureTable.js';\n\nexport class BatchTable extends FeatureTable {\n\n\tget batchSize() {\n\n\t\tconsole.warn( 'BatchTable.batchSize has been deprecated and replaced with BatchTable.count.' );\n\t\treturn this.count;\n\n\t}\n\n\tconstructor( buffer, count, start, headerLength, binLength ) {\n\n\t\tsuper( buffer, start, headerLength, binLength );\n\t\tthis.count = count;\n\n\t\tthis.extensions = {};\n\t\tconst extensions = this.header.extensions;\n\t\tif ( extensions ) {\n\n\t\t\tif ( extensions[ '3DTILES_batch_table_hierarchy' ] ) {\n\n\t\t\t\tthis.extensions[ '3DTILES_batch_table_hierarchy' ] = new BatchTableHierarchyExtension( this );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\tgetData( key, componentType = null, type = null ) {\n\n\t\tconsole.warn( 'BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get all' +\n\t\t\t'properties for an id or BatchTable.getPropertyArray for getting an array of value for a property.' );\n\t\treturn super.getData( key, this.count, componentType, type );\n\n\t}\n\n\tgetDataFromId( id, target = {} ) {\n\n\t\tif ( id < 0 || id >= this.count ) {\n\n\t\t\tthrow new Error( `BatchTable: id value \"${ id }\" out of bounds for \"${ this.count }\" features number.` );\n\n\t\t}\n\n\t\tfor ( const key of this.getKeys() ) {\n\n\t\t\ttarget[ key ] = super.getData( key, this.count )[ id ];\n\n\t\t}\n\n\t\tfor ( const extensionName in this.extensions ) {\n\n\t\t\tconst extension = this.extensions[ extensionName ];\n\n\t\t\tif ( extension.getDataFromId instanceof Function ) {\n\n\t\t\t\ttarget[ extensionName ] = target[ extensionName ] || {};\n\t\t\t\textension.getDataFromId( id, target[ extensionName ] );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn target;\n\n\t}\n\n\tgetPropertyArray( key ) {\n\n\t\treturn super.getData( key, this.count );\n\n\t}\n\n\n}\n","// B3DM File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Batched3DModel/README.md\n\nimport { BatchTable } from '../utilities/BatchTable.js';\nimport { FeatureTable } from '../utilities/FeatureTable.js';\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes } from '../utilities/LoaderUtils.js';\n\nexport class B3DMLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\t// TODO: this should be able to take a uint8array with an offset and length\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 28-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'b3dm' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1 );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength );\n\n\t\t// 4 bytes\n\t\tconst featureTableJSONByteLength = dataView.getUint32( 12, true );\n\n\t\t// 4 bytes\n\t\tconst featureTableBinaryByteLength = dataView.getUint32( 16, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableJSONByteLength = dataView.getUint32( 20, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableBinaryByteLength = dataView.getUint32( 24, true );\n\n\t\t// Feature Table\n\t\tconst featureTableStart = 28;\n\t\tconst featureTableBuffer = buffer.slice(\n\t\t\tfeatureTableStart,\n\t\t\tfeatureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength,\n\t\t);\n\t\tconst featureTable = new FeatureTable(\n\t\t\tfeatureTableBuffer,\n\t\t\t0,\n\t\t\tfeatureTableJSONByteLength,\n\t\t\tfeatureTableBinaryByteLength,\n\t\t);\n\n\t\t// Batch Table\n\t\tconst batchTableStart = featureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength;\n\t\tconst batchTableBuffer = buffer.slice(\n\t\t\tbatchTableStart,\n\t\t\tbatchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength,\n\t\t);\n\t\tconst batchTable = new BatchTable(\n\t\t\tbatchTableBuffer,\n\t\t\tfeatureTable.getData( 'BATCH_LENGTH' ),\n\t\t\t0,\n\t\t\tbatchTableJSONByteLength,\n\t\t\tbatchTableBinaryByteLength,\n\t\t);\n\n\t\tconst glbStart = batchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength;\n\t\tconst glbBytes = new Uint8Array( buffer, glbStart, byteLength - glbStart );\n\n\t\treturn {\n\t\t\tversion,\n\t\t\tfeatureTable,\n\t\t\tbatchTable,\n\t\t\tglbBytes,\n\t\t};\n\n\t}\n\n}\n\n","// I3DM File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Instanced3DModel/README.md\n\nimport { BatchTable } from '../utilities/BatchTable.js';\nimport { FeatureTable } from '../utilities/FeatureTable.js';\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes, arrayToString, getWorkingPath } from '../utilities/LoaderUtils.js';\n\nexport class I3DMLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 32-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'i3dm' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1 );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength );\n\n\t\t// 4 bytes\n\t\tconst featureTableJSONByteLength = dataView.getUint32( 12, true );\n\n\t\t// 4 bytes\n\t\tconst featureTableBinaryByteLength = dataView.getUint32( 16, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableJSONByteLength = dataView.getUint32( 20, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableBinaryByteLength = dataView.getUint32( 24, true );\n\n\t\t// 4 bytes\n\t\tconst gltfFormat = dataView.getUint32( 28, true );\n\n\t\t// Feature Table\n\t\tconst featureTableStart = 32;\n\t\tconst featureTableBuffer = buffer.slice(\n\t\t\tfeatureTableStart,\n\t\t\tfeatureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength,\n\t\t);\n\t\tconst featureTable = new FeatureTable(\n\t\t\tfeatureTableBuffer,\n\t\t\t0,\n\t\t\tfeatureTableJSONByteLength,\n\t\t\tfeatureTableBinaryByteLength,\n\t\t);\n\n\t\t// Batch Table\n\t\tconst batchTableStart = featureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength;\n\t\tconst batchTableBuffer = buffer.slice(\n\t\t\tbatchTableStart,\n\t\t\tbatchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength,\n\t\t);\n\t\tconst batchTable = new BatchTable(\n\t\t\tbatchTableBuffer,\n\t\t\tfeatureTable.getData( 'INSTANCES_LENGTH' ),\n\t\t\t0,\n\t\t\tbatchTableJSONByteLength,\n\t\t\tbatchTableBinaryByteLength,\n\t\t);\n\n\t\tconst glbStart = batchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength;\n\t\tconst bodyBytes = new Uint8Array( buffer, glbStart, byteLength - glbStart );\n\n\t\tlet glbBytes = null;\n\t\tlet promise = null;\n\t\tlet gltfWorkingPath = null;\n\t\tif ( gltfFormat ) {\n\n\t\t\tglbBytes = bodyBytes;\n\t\t\tpromise = Promise.resolve();\n\n\t\t} else {\n\n\t\t\tconst externalUri = this.resolveExternalURL( arrayToString( bodyBytes ) );\n\n\t\t\t//Store the gltf working path\n\t\t\tgltfWorkingPath = getWorkingPath( externalUri );\n\n\t\t\tpromise = fetch( externalUri, this.fetchOptions )\n\t\t\t\t.then( res => {\n\n\t\t\t\t\tif ( ! res.ok ) {\n\n\t\t\t\t\t\tthrow new Error( `I3DMLoaderBase : Failed to load file \"${ externalUri }\" with status ${ res.status } : ${ res.statusText }` );\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn res.arrayBuffer();\n\n\t\t\t\t} )\n\t\t\t\t.then( buffer => {\n\n\t\t\t\t\tglbBytes = new Uint8Array( buffer );\n\n\t\t\t\t} );\n\n\t\t}\n\n\t\treturn promise.then( () => {\n\n\t\t\treturn {\n\t\t\t\tversion,\n\t\t\t\tfeatureTable,\n\t\t\t\tbatchTable,\n\t\t\t\tglbBytes,\n\t\t\t\tgltfWorkingPath\n\t\t\t};\n\n\t\t} );\n\n\t}\n\n}\n\n","// PNTS File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/PointCloud/README.md\n\nimport { BatchTable } from '../utilities/BatchTable.js';\nimport { FeatureTable } from '../utilities/FeatureTable.js';\nimport { readMagicBytes } from '../utilities/LoaderUtils.js';\nimport { LoaderBase } from './LoaderBase.js';\n\nexport class PNTSLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 28-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'pnts' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1 );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength );\n\n\t\t// 4 bytes\n\t\tconst featureTableJSONByteLength = dataView.getUint32( 12, true );\n\n\t\t// 4 bytes\n\t\tconst featureTableBinaryByteLength = dataView.getUint32( 16, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableJSONByteLength = dataView.getUint32( 20, true );\n\n\t\t// 4 bytes\n\t\tconst batchTableBinaryByteLength = dataView.getUint32( 24, true );\n\n\t\t// Feature Table\n\t\tconst featureTableStart = 28;\n\t\tconst featureTableBuffer = buffer.slice(\n\t\t\tfeatureTableStart,\n\t\t\tfeatureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength,\n\t\t);\n\t\tconst featureTable = new FeatureTable(\n\t\t\tfeatureTableBuffer,\n\t\t\t0,\n\t\t\tfeatureTableJSONByteLength,\n\t\t\tfeatureTableBinaryByteLength,\n\t\t);\n\n\t\t// Batch Table\n\t\tconst batchTableStart = featureTableStart + featureTableJSONByteLength + featureTableBinaryByteLength;\n\t\tconst batchTableBuffer = buffer.slice(\n\t\t\tbatchTableStart,\n\t\t\tbatchTableStart + batchTableJSONByteLength + batchTableBinaryByteLength,\n\t\t);\n\t\tconst batchTable = new BatchTable(\n\t\t\tbatchTableBuffer,\n\t\t\tfeatureTable.getData( 'BATCH_LENGTH' ) || featureTable.getData( 'POINTS_LENGTH' ),\n\t\t\t0,\n\t\t\tbatchTableJSONByteLength,\n\t\t\tbatchTableBinaryByteLength,\n\t\t);\n\n\t\treturn Promise.resolve( {\n\n\t\t\tversion,\n\t\t\tfeatureTable,\n\t\t\tbatchTable,\n\n\t\t} );\n\n\t}\n\n}\n\n","// CMPT File Format\n// https://github.com/CesiumGS/3d-tiles/blob/master/specification/TileFormats/Composite/README.md\nimport { LoaderBase } from './LoaderBase.js';\nimport { readMagicBytes } from '../utilities/LoaderUtils.js';\n\nexport class CMPTLoaderBase extends LoaderBase {\n\n\tparse( buffer ) {\n\n\t\tconst dataView = new DataView( buffer );\n\n\t\t// 16-byte header\n\n\t\t// 4 bytes\n\t\tconst magic = readMagicBytes( dataView );\n\n\t\tconsole.assert( magic === 'cmpt', 'CMPTLoader: The magic bytes equal \"cmpt\".' );\n\n\t\t// 4 bytes\n\t\tconst version = dataView.getUint32( 4, true );\n\n\t\tconsole.assert( version === 1, 'CMPTLoader: The version listed in the header is \"1\".' );\n\n\t\t// 4 bytes\n\t\tconst byteLength = dataView.getUint32( 8, true );\n\n\t\tconsole.assert( byteLength === buffer.byteLength, 'CMPTLoader: The contents buffer length listed in the header matches the file.' );\n\n\t\t// 4 bytes\n\t\tconst tilesLength = dataView.getUint32( 12, true );\n\n\t\tconst tiles = [];\n\t\tlet offset = 16;\n\t\tfor ( let i = 0; i < tilesLength; i ++ ) {\n\n\t\t\tconst tileView = new DataView( buffer, offset, 12 );\n\t\t\tconst tileMagic = readMagicBytes( tileView );\n\t\t\tconst tileVersion = tileView.getUint32( 4, true );\n\t\t\tconst byteLength = tileView.getUint32( 8, true );\n\n\t\t\tconst tileBuffer = new Uint8Array( buffer, offset, byteLength );\n\t\t\ttiles.push( {\n\n\t\t\t\ttype: tileMagic,\n\t\t\t\tbuffer: tileBuffer,\n\t\t\t\tversion: tileVersion,\n\n\t\t\t} );\n\t\t\toffset += byteLength;\n\n\t\t}\n\n\t\treturn {\n\t\t\tversion,\n\t\t\ttiles,\n\t\t};\n\n\t}\n\n}\n\n"],"names":["getUrlExtension","url","endIndex","queryIndex","fragmentIndex","lastPeriodIndex","lastSlashIndex","protocolIndex","viewErrorTarget","LOAD_ROOT_SIBLINGS","isDownloadFinished","value","LOADED","FAILED","isUsedThisFrame","tile","frameCount","areChildrenProcessed","canUnconditionallyRefine","resetFrameState","renderer","recursivelyMarkUsed","cacheOnly","markUsed","children","i","l","recursivelyLoadNextRenderableTiles","canTraverse","markUsedTiles","anyChildrenUsed","anyChildrenInFrustum","c","markUsedSetLeaves","allChildrenReady","childCanDisplay","isChildReady","markVisibleTiles","stats","hasContent","loadedContent","errorRequirement","meetsSSE","isAdditiveRefine","toggleTiles","isUsed","setActive","setVisible","plugin","throttle","callback","handle","PLUGIN_REGISTERED","priorityCallback","a","b","aPriority","bPriority","lruPriorityCallback","TilesRendererBase","tileset","isLoading","loading","total","v","cachedRootJson","UNLOADED","lruCache","LRUCache","downloadQueue","PriorityQueue","parseQueue","processNodeQueue","plugins","priority","insertionPoint","index","name","p","func","result","pending","beforecb","aftercb","ensureFullyProcessed","traverseSet","args","target","usedSet","root","LOADING","processedUrl","error","queuedTiles","toRemove","t","scene","buffer","extension","tilesetDir","parentTile","_a","active","visible","options","immediate","child","bytes","processedTiles","item","json","parent","proto","version","major","minor","basePath","res","isExternalTileset","externalTileset","uri","controller","signal","PARSING","downloadTile","content","parseTile","bytesUsed","parseBinArray","arrayStart","count","type","componentType","propertyName","stride","data","arrayLength","FeatureTable","start","headerLength","binLength","header","headerData","arrayToString","key","defaultComponentType","defaultType","feature","binOffset","byteOffset","featureType","featureComponentType","byteLength","BatchTableHierarchyExtension","batchTable","extensionHeader","classDef","instances","property","parentIdsLength","classCounter","classId","propertyLength","id","parentCount","parentIdsOffset","parentId","className","instanceId","BatchTable","extensions","extensionName","B3DMLoaderBase","LoaderBase","dataView","magic","readMagicBytes","featureTableJSONByteLength","featureTableBinaryByteLength","batchTableJSONByteLength","batchTableBinaryByteLength","featureTableStart","featureTableBuffer","featureTable","batchTableStart","batchTableBuffer","glbStart","glbBytes","I3DMLoaderBase","gltfFormat","bodyBytes","promise","gltfWorkingPath","externalUri","getWorkingPath","PNTSLoaderBase","CMPTLoaderBase","tilesLength","tiles","offset","tileView","tileMagic","tileVersion","tileBuffer"],"mappings":"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"}